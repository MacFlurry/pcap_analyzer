{% extends "base.html" %}

{% block title %}Réinitialiser mot de passe - PCAP Analyzer{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center px-4 py-12">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="bg-gradient-primary p-4 rounded-2xl inline-block mb-4">
                <i class="fas fa-key text-white text-4xl"></i>
            </div>
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">
                Nouveau mot de passe
            </h2>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400" id="header-text">
                Veuillez choisir un nouveau mot de passe sécurisé.
            </p>
        </div>

        <!-- Initial Loading State -->
        <div id="loading-state" class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-primary text-3xl mb-4"></i>
            <p class="text-gray-600 dark:text-gray-400">Vérification du lien...</p>
        </div>

        <!-- Invalid Token State -->
        <div id="invalid-token-state" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
            <div class="bg-red-100 dark:bg-red-900/30 p-4 rounded-full inline-block mb-4">
                <i class="fas fa-times-circle text-red-500 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Lien invalide ou expiré</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                Ce lien de réinitialisation n'est plus valide. Veuillez faire une nouvelle demande.
            </p>
            <a href="/forgot-password" class="inline-block bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                Nouvelle demande
            </a>
        </div>

        <!-- Reset Form -->
        <div id="reset-form-container" class="hidden bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 space-y-6">
            <p class="text-sm text-center text-gray-500 dark:text-gray-400 mb-4">
                Compte : <span id="user-email" class="font-bold text-gray-700 dark:text-gray-200"></span>
            </p>

            <form id="reset-password-form" class="space-y-6">
                <!-- New Password -->
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Nouveau mot de passe
                    </label>
                    <div class="relative">
                        <input
                            type="password"
                            id="new_password"
                            name="new_password"
                            required
                            class="appearance-none relative block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors pr-12"
                            placeholder="Minimum 12 caractères"
                        >
                        <button
                            type="button"
                            id="toggle-password"
                            class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <!-- Password Strength Meter -->
                    <div class="mt-2">
                        <div class="h-1 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div id="strength-bar" class="h-full bg-red-500 w-0 transition-all duration-300"></div>
                        </div>
                        <p id="strength-text" class="text-xs mt-1 text-gray-500 dark:text-gray-400 text-right">Trop faible</p>
                    </div>
                </div>

                <!-- Confirm Password -->
                <div>
                    <label for="confirm_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Confirmer le mot de passe
                    </label>
                    <input
                        type="password"
                        id="confirm_password"
                        name="confirm_password"
                        required
                        class="appearance-none relative block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
                        placeholder="Répétez le mot de passe"
                    >
                </div>

                <!-- Requirements -->
                <div class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                    <p class="font-semibold mb-1">Exigences :</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li id="req-length" class="text-red-500"><i class="fas fa-times mr-1"></i> 12 caractères minimum</li>
                        <li id="req-strength" class="text-red-500"><i class="fas fa-times mr-1"></i> Force "Bonne" ou "Excellente"</li>
                        <li id="req-match" class="text-red-500"><i class="fas fa-times mr-1"></i> Mots de passe identiques</li>
                    </ul>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="hidden p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                        <p class="text-sm text-red-700 dark:text-red-300" id="error-text"></p>
                    </div>
                </div>

                <!-- Submit Button -->
                <button
                    type="submit"
                    id="submit-button"
                    disabled
                    class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-primary hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span class="absolute left-0 inset-y-0 flex items-center pl-4">
                        <i class="fas fa-save text-white/80"></i>
                    </span>
                    <span id="button-text">Réinitialiser le mot de passe</span>
                    <span id="spinner" class="hidden ml-3">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Load zxcvbn library for frontend strength estimation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>
{% endblock %}

{% block extra_scripts %}
<script>
// Get token from URL
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

if (!token) {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('invalid-token-state').classList.remove('hidden');
} else {
    // Validate token on load
    validateToken();
}

async function validateToken() {
    try {
        const response = await fetch('/api/auth/validate-reset-token', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        
        document.getElementById('loading-state').classList.add('hidden');
        
        if (response.ok && data.valid) {
            document.getElementById('reset-form-container').classList.remove('hidden');
            document.getElementById('user-email').textContent = data.email;
        } else {
            document.getElementById('invalid-token-state').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Validation error:', error);
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('invalid-token-state').classList.remove('hidden');
    }
}

// Password strength and validation logic
const passwordInput = document.getElementById('new_password');
const confirmInput = document.getElementById('confirm_password');
const submitButton = document.getElementById('submit-button');
const strengthBar = document.getElementById('strength-bar');
const strengthText = document.getElementById('strength-text');

// Requirements elements
const reqLength = document.getElementById('req-length');
const reqStrength = document.getElementById('req-strength');
const reqMatch = document.getElementById('req-match');

function updateRequirement(element, isValid) {
    if (isValid) {
        element.classList.remove('text-red-500');
        element.classList.add('text-green-500');
        element.querySelector('i').classList.remove('fa-times');
        element.querySelector('i').classList.add('fa-check');
    } else {
        element.classList.remove('text-green-500');
        element.classList.add('text-red-500');
        element.querySelector('i').classList.remove('fa-check');
        element.querySelector('i').classList.add('fa-times');
    }
}

function validateForm() {
    const password = passwordInput.value;
    const confirm = confirmInput.value;
    
    // 1. Check length
    const isLengthValid = password.length >= 12;
    updateRequirement(reqLength, isLengthValid);
    
    // 2. Check strength (using zxcvbn)
    let score = 0;
    if (password) {
        const result = zxcvbn(password);
        score = result.score;
    }
    
    // Update bar UI
    const colors = ['bg-red-500', 'bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-green-600'];
    const widths = ['w-0', 'w-1/4', 'w-2/4', 'w-3/4', 'w-full'];
    const texts = ['Très faible', 'Faible', 'Moyen', 'Bon', 'Excellent'];
    
    strengthBar.className = `h-full transition-all duration-300 ${colors[score]} ${widths[score]}`;
    strengthText.textContent = texts[score];
    strengthText.className = `text-xs mt-1 text-right ${score >= 3 ? 'text-green-600' : 'text-gray-500'}`;
    
    const isStrengthValid = score >= 3;
    updateRequirement(reqStrength, isStrengthValid);
    
    // 3. Check match
    const isMatchValid = password === confirm && password.length > 0;
    updateRequirement(reqMatch, isMatchValid);
    
    // Enable submit if all valid
    submitButton.disabled = !(isLengthValid && isStrengthValid && isMatchValid);
}

passwordInput.addEventListener('input', validateForm);
confirmInput.addEventListener('input', validateForm);

// Toggle password visibility
document.getElementById('toggle-password').addEventListener('click', function() {
    const icon = this.querySelector('i');
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
});

// Handle form submission
document.getElementById('reset-password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password = passwordInput.value;
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    
    // Reset errors
    errorMessage.classList.add('hidden');
    submitButton.disabled = true;
    buttonText.textContent = 'Traitement...';
    spinner.classList.remove('hidden');
    
    try {
        const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                token: token,
                new_password: password
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (window.toast) window.toast.success('Mot de passe réinitialisé !', 3000);
            
            // Redirect to login after success
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            let errorMsg = data.detail || 'Erreur lors de la réinitialisation.';
            // Handle validation array
            if (Array.isArray(data.detail)) {
                errorMsg = data.detail.map(e => e.msg).join(', ');
            }
            errorText.textContent = errorMsg;
            errorMessage.classList.remove('hidden');
            submitButton.disabled = false;
            buttonText.textContent = 'Réinitialiser le mot de passe';
            spinner.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error:', error);
        errorText.textContent = 'Erreur de connexion au serveur.';
        errorMessage.classList.remove('hidden');
        submitButton.disabled = false;
        buttonText.textContent = 'Réinitialiser le mot de passe';
        spinner.classList.add('hidden');
    }
});
</script>
{% endblock %}
