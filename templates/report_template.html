<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <title>Rapport d'analyse PCAP - {{ analysis_info.pcap_file }}</title>
    <!-- External CSS for better maintainability and dark mode support -->
    <style>
        /* Inline CSS embedding for self-contained HTML reports */
        {{ embedded_css }}
    </style>
</head>
<body>
    {% macro format_bytes(value) %}
    {% set bytes = value or 0 %}
    {% if bytes < 1024 %}
        {{ bytes }} B
    {% elif bytes < 1048576 %}
        {{ "%.2f"|format(bytes / 1024) }} KB
    {% elif bytes < 1073741824 %}
        {{ "%.2f"|format(bytes / 1048576) }} MB
    {% else %}
        {{ "%.2f"|format(bytes / 1073741824) }} GB
    {% endif %}
    {% endmacro %}

    {% macro format_bitrate(value_mbps) %}
    {% set mbps = value_mbps or 0 %}
    {% if mbps < 0.001 %}
        {{ "%.0f"|format(mbps * 1000000) }} bps
    {% elif mbps < 1 %}
        {{ "%.2f"|format(mbps * 1000) }} Kbps
    {% elif mbps < 1000 %}
        {{ "%.2f"|format(mbps) }} Mbps
    {% else %}
        {{ "%.2f"|format(mbps / 1000) }} Gbps
    {% endif %}
    {% endmacro %}

    {% macro format_port(port) %}
        {% set service_name = common_ports.get(port) %}
        {% if service_name %}
            {{ port }} ({{ service_name }})
        {% else %}
            {{ port }}
        {% endif %}
    {% endmacro %}

    <div class="container">
        <header>
            <h1>üìä PCAP Analyzer</h1>
            <div class="meta-info">
                <strong>Fichier PCAP:</strong> {{ analysis_info.pcap_file }}<br>
                <strong>Date d'analyse:</strong> {{ analysis_info.analysis_date }}<br>
                <strong>Dur√©e de capture:</strong> {{ "%.2f"|format(analysis_info.capture_duration) }} secondes<br>
                <strong>Total de paquets:</strong> {{ analysis_info.total_packets }}<br>
                <span style="display: inline-block; margin-top: 5px; padding: 3px 8px; background-color: #2196F3; color: white; border-radius: 3px; font-size: 0.85em;">IPv4 & IPv6</span>
            </div>
        </header>

        <!-- Vue d'ensemble -->
        <h2>Vue d'ensemble</h2>
        <div class="summary-grid">
            <div class="summary-card {% if timestamps['gaps_detected'] > 0 and (not timestamps.get('periodic_pattern_detected', false) or timestamps.get('non_periodic_gaps', 0) > 0) and retransmission and retransmission.rto_count > 0 %}warning{% else %}success{% endif %}">
                <h3>
                    {% if timestamps['gaps_detected'] > 0 and (retransmission.rto_count == 0 or analysis_info.is_very_small_capture) %}
                        Pauses applicatives
                    {% elif timestamps['gaps_detected'] > 0 %}
                        Gaps anormaux
                    {% else %}
                        Aucun gap anormal
                    {% endif %}
                </h3>
                <div class="value">
                    {% if timestamps.get('periodic_pattern_detected', false) %}
                        {{ timestamps.get('non_periodic_gaps', 0) }}
                    {% else %}
                        {{ timestamps['gaps_detected'] }}
                    {% endif %}
                </div>
            </div>

            <div class="summary-card {% if tcp_handshake.slow_handshakes > 0 %}warning{% else %}success{% endif %}">
                <h3>Handshakes lents</h3>
                <div class="value">{{ tcp_handshake.slow_handshakes }}</div>
            </div>

            <div class="summary-card {% if analysis_info.rto_rate > 0.5 or retransmission.rto_count > 50 %}danger{% elif analysis_info.rto_rate > 0.05 or retransmission.rto_count > 5 %}warning{% else %}success{% endif %}">
                <h3>Retransmissions</h3>
                <div class="value">{{ retransmission.total_retransmissions }}</div>
                <small>
                    {% if retransmission.rto_count > 0 %}
                        {% if analysis_info.rto_rate > 0.05 or retransmission.rto_count > 5 %}üî¥{% else %}üîµ{% endif %} RTO: {{ retransmission.rto_count }}
                    {% endif %}
                    {% if retransmission.fast_retrans_count > 0 %}üü† FR: {{ retransmission.fast_retrans_count }}{% endif %}
                    {% if retransmission.other_retrans_count > 0 %}üîµ OT: {{ retransmission.other_retrans_count }}{% endif %}
                </small>
            </div>

            <div class="summary-card {% if tcp_window.flows_with_issues > 0 %}warning{% else %}success{% endif %}">
                <h3>Probl√®mes fen√™tre TCP</h3>
                <div class="value">{{ tcp_window.flows_with_issues }}</div>
            </div>

            <div class="summary-card {% if icmp.pmtu_issues_count > 0 %}danger{% elif icmp.dest_unreachable_count > 0 %}warning{% else %}success{% endif %}">
                <h3>Probl√®mes ICMP</h3>
                <div class="value">{{ icmp.pmtu_issues_count + icmp.dest_unreachable_count }}</div>
            </div>

            <div class="summary-card {% if dns.timeout_transactions > 0 or dns.slow_transactions > 0 %}warning{% else %}success{% endif %}">
                <h3>Probl√®mes DNS</h3>
                <div class="value">{{ dns.timeout_transactions + dns.slow_transactions }}</div>
            </div>
        </div>

        <!-- Analyse des timestamps -->
        {% if timestamps['gaps_detected'] > 0 and (not timestamps.get('periodic_pattern_detected', false) or timestamps.get('non_periodic_gaps', 0) > 0) %}
        <h2>‚è±Ô∏è Analyse des timestamps</h2>
                <div class="section {% if retransmission and retransmission.rto_count == 0 and not analysis_info.is_very_small_capture %}success{% else %}warning{% endif %}">
                    <h3>
                        {{ timestamps.get('non_periodic_gaps', timestamps['gaps_detected']) }}
                        {% if retransmission and retransmission.rto_count == 0 and not analysis_info.is_very_small_capture %}
                            p√©riode(s) de silence d√©tect√©e(s) (Pause Applicative)
                        {% else %}
                            gap(s) temporel(s) anormal(aux) d√©tect√©(s)
                        {% endif %}
                    </h3>
                    
                    <div class="info-box">
                        <p><strong>üîç Comprendre les Gaps Temporels :</strong></p>
                        <ul>
                            <li><strong>D√©finition :</strong> Une p√©riode de "silence" anormalement longue entre deux paquets cons√©cutifs dans un m√™me flux ou globalement.</li>
                            <li><strong>Implications :</strong>
                                <ul>
                                    <li><strong>C√¥t√© Serveur :</strong> Peut indiquer un traitement long (traitement de base de donn√©es, Garbage Collection, attente I/O).</li>
                                    <li><strong>C√¥t√© R√©seau :</strong> Peut indiquer une perte de connectivit√© temporaire ou un changement de route.</li>
                                    <li><strong>C√¥t√© Client :</strong> Peut √™tre une pause utilisateur ou un script qui attend.</li>
                                </ul>
                            </li>
                            <li><strong>Investigation :</strong> Notez les timestamps exacts et corr√©lez-les avec les logs de vos serveurs (fichiers de log, graphiques CPU/RAM) pour voir s'il y avait une activit√© intense ou une erreur √† ce moment-l√†.</li>
                        </ul>
                    </div>
                    
                    {% if timestamps.get('periodic_pattern_detected', false) %}
                    <div class="alert alert-info" style="margin-bottom: 15px;">
                        <strong>‚ÑπÔ∏è Pattern p√©riodique d√©tect√©:</strong> {{ timestamps['gaps_detected'] - timestamps.get('non_periodic_gaps', 0) }} gaps r√©guliers ont √©t√© masqu√©s.
                        Seuls les gaps hors pattern sont affich√©s ci-dessous.
                    </div>
                    {% endif %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">
                    {% if retransmission and retransmission.rto_count == 0 and not analysis_info.is_very_small_capture %}
                        üìã Liste d√©taill√©e des p√©riodes de silence
                    {% else %}
                        üìã Liste d√©taill√©e des gaps anormaux
                    {% endif %}
                </span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>Paquets</th>
                                <th>Dur√©e du gap</th>
                                <th>Direction</th>
                                <th>Protocole</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set count = namespace(value=0) %}
                            {% for gap in timestamps['gaps'] %}
                            {% if gap.is_abnormal and count.value < 10 %}
                            {% set count.value = count.value + 1 %}
                            <tr>
                                <td>#{{ gap.packet_num_before }} ‚Üí #{{ gap.packet_num_after }}</td>
                                <td><strong>{{ "%.3f"|format(gap.gap_duration) }}s</strong></td>
                                <td><code>{{ gap.src_ip }} ‚Üí {{ gap.dst_ip }}</code></td>
                                <td><span class="badge info">{{ gap.protocol }}</span></td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Handshakes TCP -->
        {% if tcp_handshake.slow_handshakes > 0 %}
        <h2>ü§ù Analyse des handshakes TCP</h2>
        <div class="section warning">
            <h3>{{ tcp_handshake.slow_handshakes }} handshake(s) lent(s)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>Dur√©e totale</th>
                        <th>SYN‚ÜíSYN/ACK</th>
                        <th>SYN/ACK‚ÜíACK</th>
                        <th>C√¥t√© suspect</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hs in tcp_handshake.slow_handshake_details %}
                    <tr>
                        <td><code>{{ hs.src_ip }}:{{ hs.src_port }} ‚Üí {{ hs.dst_ip }}:{{ hs.dst_port }}</code></td>
                        <td><strong>{{ "%.3f"|format(hs.total_handshake_time or 0) }}s</strong></td>
                        <td>{{ "%.3f"|format(hs.syn_to_synack_delay or 0) }}s</td>
                        <td>{{ "%.3f"|format(hs.synack_to_ack_delay or 0) }}s</td>
                        <td>
                            {% if hs.suspected_side == 'server' %}
                            <span class="badge danger">Serveur</span>
                            {% elif hs.suspected_side == 'client' %}
                            <span class="badge warning">Client</span>
                            {% elif hs.suspected_side == 'network' %}
                            <span class="badge info">R√©seau</span>
                            {% else %}
                            <span class="badge">{{ hs.suspected_side }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Retransmissions -->
        {% if retransmission.total_retransmissions > 0 %}
        <h2>üîÑ Retransmissions et anomalies TCP</h2>
        <div class="section {% if retransmission.total_retransmissions > 50 %}danger{% else %}warning{% endif %}">
            <h3>{{ retransmission.total_retransmissions }} retransmission(s) d√©tect√©e(s){% if retransmission.flows_with_issues > 0 %} - {{ retransmission.flows_with_issues }} flux avec probl√®mes{% endif %}</h3>
            <p><strong>Retransmissions totales:</strong> {{ retransmission.total_retransmissions }} ({{ retransmission.unique_retransmitted_segments }} segments uniques)</p>
            <p>
                {% if retransmission.rto_count > 0 %}
                    {% if analysis_info.rto_rate > 0.05 or retransmission.rto_count > 5 %}
                    üî¥ <strong>RTOs (Timeout de Retransmission):</strong> {{ retransmission.rto_count }} ({{ "%.2f"|format(analysis_info.rto_rate) }}%) - <span style="font-size:0.9em;">Indique une congestion s√©v√®re ou une perte de paquets prolong√©e.</span>
                    {% else %}
                    üîµ <strong>RTOs (Timeout de Retransmission):</strong> {{ retransmission.rto_count }} ({{ "%.2f"|format(analysis_info.rto_rate) }}%) - <span style="font-size:0.9em;">Volume n√©gligeable (impact minime).</span>
                    {% endif %}
                    <br>
                {% endif %}
                {% if retransmission.fast_retrans_count > 0 %}
                üü† <strong>Fast Retransmissions:</strong> {{ retransmission.fast_retrans_count }} - <span style="font-size:0.9em;">Indique des pertes de paquets l√©g√®res ou un d√©sordre des paquets.</span><br>
                {% endif %}
                {% if retransmission.other_retrans_count > 0 %}
                üîµ <strong>Autres Retransmissions:</strong> {{ retransmission.other_retrans_count }}<br>
                {% endif %}
            </p>
            <p><strong>Anomalies totales:</strong> {{ retransmission.total_anomalies }}</p>

            {% if retransmission.flows_with_issues > 0 %}
            <h4>Flux les plus probl√©matiques:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>S√©v√©rit√©</th>
                        <th>Retransmissions</th>
                        <th>DUP ACK</th>
                        <th>Out-of-Order</th>
                        <th>Zero Window</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in retransmission.flow_statistics[:15] %}
                    {% if flow.severity != 'none' %}
                    <tr>
                        <td><code>{{ flow.src_ip }}:{{ format_port(flow.src_port) }} ‚Üí {{ flow.dst_ip }}:{{ format_port(flow.dst_port) }}</code></td>
                        <td>
                            {% if flow.severity == 'critical' %}
                            <span class="badge danger">CRITIQUE</span>
                            {% elif flow.severity == 'medium' %}
                            <span class="badge warning">MOYEN</span>
                            {% else %}
                            <span class="badge info">BAS</span>
                            {% endif %}
                        </td>
                        <td>{{ flow.retransmissions }}</td>
                        <td>{{ flow.dup_acks }}</td>
                        <td>{{ flow.out_of_order }}</td>
                        <td>{{ flow.zero_windows }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            {% if retransmission.retrans_by_flow %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üìã D√©tails des retransmissions par flux (Top {{ [retransmission.retrans_by_flow|length, 10]|min }})</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    {% for flow_data in retransmission.retrans_by_flow[:10] %}
                    <div class="collapsible-header detail-header">
                        <span class="toggle-icon">‚ñ∂</span>
                        <span class="header-title">{{ flow_data.flow_key }}</span>
                        <span class="header-info">({{ flow_data.total_retransmissions_in_flow }} retransmissions)</span>
                    </div>
                    <div class="collapsible-content detail-content">
                        <div class="content-inner">
                            <div class="detail-box">
                                <h5>D√©tails pour le flux <code>{{ flow_data.flow_key }}</code></h5>
                                <ul class="timeline-list">
                                    {% for r in flow_data.details %}
                                    <li>
                                        Retransmission #{{ loop.index }}: Paquet <span class="attempt-num">{{ r.packet_num }}</span> (Original: #{{ r.original_packet_num }})
                                        <span class="time-offset">D√©lai: {{ "%.2f"|format(r.delay * 1000) }}ms</span>
                                        <br>Seq: {{ r.seq_num }} - Type: <strong>{{ r.retrans_type }}</strong>
                                    </li>
                                    {% endfor %}
                                </ul>
                                <div class="filter-box">
                                    <span class="filter-label">üîç Filtre tcpdump:</span>
                                    <div class="filter-command">tcpdump -r file.pcap -tttt -nn 'tcp and host {{ flow_data.details[0].src_ip }} and port {{ flow_data.details[0].src_port }} and host {{ flow_data.details[0].dst_ip }} and port {{ flow_data.details[0].dst_port }}'</div>
                                </div>
                                <div class="filter-box">
                                    <span class="filter-label">üîç Filtre Wireshark:</span>
                                    <div class="filter-command">ip.addr == {{ flow_data.details[0].src_ip }} && tcp.port == {{ flow_data.details[0].src_port }} && ip.addr == {{ flow_data.details[0].dst_ip }} && tcp.port == {{ flow_data.details[0].dst_port }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- SYN Retransmissions -->
        {% if syn_retransmissions.total_syn_retransmissions and syn_retransmissions.total_syn_retransmissions > 0 %}
        <h2>üî¥ Retransmissions SYN - Probl√®mes de Handshake</h2>
        <div class="section danger">
            <h3>{{ syn_retransmissions.total_syn_retransmissions }} handshake(s) avec retransmissions SYN excessives</h3>
            <p><strong>Seuil de d√©tection:</strong> {{ syn_retransmissions.threshold_seconds }}s</p>
            
            {% if syn_retransmissions.delay_statistics %}
            <div class="summary-grid">
                <div class="summary-card danger">
                    <h4>D√©lai minimum</h4>
                    <div class="value">{{ "%.3f"|format(syn_retransmissions.delay_statistics.min_delay) }}s</div>
                </div>
                <div class="summary-card danger">
                    <h4>D√©lai maximum</h4>
                    <div class="value">{{ "%.3f"|format(syn_retransmissions.delay_statistics.max_delay) }}s</div>
                </div>
                <div class="summary-card danger">
                    <h4>D√©lai moyen</h4>
                    <div class="value">{{ "%.3f"|format(syn_retransmissions.delay_statistics.avg_delay) }}s</div>
                </div>
            </div>
            {% endif %}

            <h4>Top 10 des connexions les plus lentes:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Connexion</th>
                        <th>Retransmissions SYN</th>
                        <th>D√©lai total</th>
                        <th>Probl√®me identifi√©</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hs in syn_retransmissions.top_problematic_connections[:10] %}
                    <tr>
                        <td><code>{{ hs.src_ip }}:{{ hs.src_port }} ‚Üí {{ hs.dst_ip }}:{{ hs.dst_port }}</code></td>
                        <td>{{ hs.retransmission_count }}</td>
                        <td>{{ "%.3f"|format(hs.total_delay or 0) }}s</td>
                        <td>
                            <span class="badge danger">{{ hs.suspected_issue }}</span>
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    {% if hs.suspected_issue == 'no_synack_received' %}
                                    <strong>Aucune r√©ponse SYN/ACK re√ßue</strong><br>
                                    Le serveur ne r√©pond pas aux tentatives de connexion. Causes possibles :
                                    ‚Ä¢ Serveur √©teint ou inaccessible<br>
                                    ‚Ä¢ Firewall bloquant les connexions<br>
                                    ‚Ä¢ Service non d√©marr√© sur le port demand√©
                                    {% elif hs.suspected_issue == 'server_delayed_response' %}
                                    <strong>R√©ponse serveur lente</strong><br>
                                    Le serveur r√©pond mais avec un d√©lai important. Causes possibles :
                                    ‚Ä¢ Serveur surcharg√© (CPU, RAM)<br>
                                    ‚Ä¢ Probl√®me de performance applicative<br>
                                    ‚Ä¢ Latence r√©seau √©lev√©e
                                    {% elif hs.suspected_issue == 'network_packet_loss' %}
                                    <strong>Perte de paquets r√©seau</strong><br>
                                    Des paquets SYN sont perdus en transit. Causes possibles :
                                    ‚Ä¢ Congestion r√©seau<br>
                                    ‚Ä¢ √âquipement r√©seau d√©faillant<br>
                                    ‚Ä¢ Probl√®me de routage
                                    {% elif hs.suspected_issue == 'timeout_waiting_synack' %}
                                    <strong>Timeout en attente de SYN/ACK</strong><br>
                                    Le client abandonne avant de recevoir la r√©ponse. Causes possibles :
                                    ‚Ä¢ Timeout TCP trop court<br>
                                    ‚Ä¢ Latence r√©seau excessive<br>
                                    ‚Ä¢ Serveur tr√®s lent √† r√©pondre
                                    {% else %}
                                    {{ hs.suspected_issue }}
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h4>üî¥ Top 10 des connexions les plus lentes (d√©tails):</h4>
            {% for hs in syn_retransmissions.top_problematic_connections[:10] %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">#{{ loop.index }} ‚Äì {{ hs.src_ip }}:{{ hs.src_port }} ‚Üí {{ hs.dst_ip }}:{{ hs.dst_port }}</span>
                <span class="header-info">({{ hs.retransmission_count }} retrans SYN, d√©lai: {{ "%.3f"|format(hs.total_delay or 0) }}s)</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <div class="detail-box">
                        <div class="info-line">
                            <span class="info-label">Premier SYN:</span>
                            <span class="info-value timestamp">{{ hs.first_syn_time_iso }}</span>
                        </div>
                        
                        <div class="info-line">
                            <span class="info-label">Retransmissions SYN:</span>
                            <span class="info-value count">{{ hs.retransmission_count }}</span>
                        </div>
                        
                        <div class="info-line">
                            <span class="info-label">Timeline des SYN:</span>
                        </div>
                        <ul class="timeline-list">
                            {% set first_time = hs.syn_attempts[0] if hs.syn_attempts else 0 %}
                            {% for t in hs.syn_attempts %}
                            <li>
                                ‚Äì Tentative <span class="attempt-num">#{{ loop.index }}</span>: 
                                <span class="time-offset">+{{ "%.3f"|format(t - first_time) }}s</span>
                            </li>
                            {% endfor %}
                        </ul>
                        
                        {% if hs.synack_time_iso %}
                        <div class="info-line">
                            <span class="info-label">SYN/ACK re√ßu:</span>
                            <span class="info-value timestamp success-indicator">{{ hs.synack_time_iso }}</span>
                        </div>
                        <div class="info-line">
                            <span class="info-label">D√©lai total:</span>
                            <span class="info-value count">{{ "%.3f"|format(hs.total_delay or 0) }}s</span>
                        </div>
                        {% else %}
                        <div class="info-line">
                            <span class="error-indicator">‚ùå Aucune r√©ponse SYN/ACK re√ßue</span>
                        </div>
                        {% endif %}
                        
                        <div class="info-line">
                            <span class="info-label">Probl√®me identifi√©:</span>
                            <span class="problem-badge">{{ hs.suspected_issue }}</span>
                        </div>

                        <div class="filter-box">
                            <span class="filter-label">üîç Filtre tcpdump:</span>
                            <div class="filter-command">tcpdump -r file.pcap -tttt -nn 'tcp and host {{ hs.src_ip }} and port {{ hs.src_port }} and host {{ hs.dst_ip }} and port {{ hs.dst_port }}'</div>
                        </div>

                        <div class="filter-box">
                            <span class="filter-label">üîç Filtre Wireshark:</span>
                            <div class="filter-command">ip.addr == {{ hs.src_ip }} && tcp.port == {{ hs.src_port }} && ip.addr == {{ hs.dst_ip }} && tcp.port == {{ hs.dst_port }}</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- TCP Reset (RST) -->
        {% if tcp_reset.total_resets and tcp_reset.total_resets > 0 %}
        <h2>üî¥ Analyse des TCP Reset (RST)</h2>
        <div class="section danger">
            <h3>{{ tcp_reset.total_resets }} paquet(s) RST d√©tect√©(s)</h3>
            
            <div class="summary-grid">
                <div class="summary-card danger">
                    <h4>
                        RST Pr√©matur√©s
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text">
                                Connexion refus√©e avant transfert de donn√©es (firewall, port ferm√©, service arr√™t√©).
                            </span>
                        </div>
                    </h4>
                    <div class="value">{{ tcp_reset.premature_resets }}</div>
                    <small>Avant √©change de donn√©es</small>
                </div>
                <div class="summary-card warning">
                    <h4>
                        RST Post-donn√©es
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text">
                                Connexion interrompue brutalement (crash applicatif, timeout, erreur protocole).
                            </span>
                        </div>
                    </h4>
                    <div class="value">{{ tcp_reset.post_data_resets }}</div>
                    <small>Apr√®s √©change de donn√©es</small>
                </div>
                <div class="summary-card danger">
                    <h4>Flux Impact√©s</h4>
                    <div class="value">{{ tcp_reset.flows_with_resets }}</div>
                    <small>Connexions interrompues</small>
                </div>
            </div>

                        {% if tcp_reset.top_reset_flows and tcp_reset.top_reset_flows|length > 0 %}

                        <div class="collapsible-header">

                            <span class="toggle-icon">‚ñ∂</span>

                            <span class="header-title">üìã D√©tails des flux avec RST ({{ tcp_reset.top_reset_flows|length }} flux)</span>

                        </div>

                        <div class="collapsible-content">

                            <div class="content-inner">

                                {% for flow in tcp_reset.top_reset_flows[:10] %}

                                <div class="collapsible-header detail-header">

                                    <span class="toggle-icon">‚ñ∂</span>

                                    <span class="header-title">{{ flow.flow_key }}</span>

                                    <span class="header-info">({{ flow.count }} RST, {% if flow.premature %}Pr√©matur√©{% else %}Post-donn√©es{% endif %})</span>

                                </div>

                                <div class="collapsible-content detail-content">

                                    <div class="content-inner">

                                        <div class="detail-box">

                                            <div class="info-line">

                                                <span class="info-label">Nombre de RST:</span>

                                                <span class="info-value count">{{ flow.count }}</span>

                                            </div>

                                            

                                            <div class="info-line">

                                                <span class="info-label">Type:</span>

                                                {% if flow.premature %}

                                                <span class="problem-badge">RST Pr√©matur√© (connexion refus√©e)</span>

                                                {% else %}

                                                <span class="problem-badge">RST Post-donn√©es (interruption)</span>

                                                {% endif %}

                                            </div>

                                            

                                            <div class="info-line">

                                                <span class="info-label">Timestamps des RST:</span>

                                            </div>

                                            <ul class="timeline-list">

                                                {% for ts in flow.timestamps %}

                                                <li>RST #{{ loop.index }}: <span class="time-offset">{{ ts }}</span></li>

                                                {% endfor %}

                                            </ul>

                                            

                                                                            <div class="filter-box">

                                            

                                                                                <span class="filter-label">üîç Filtre tcpdump (RST uniquement):</span>

                                            

                                                                                <div class="filter-command">tcpdump -r file.pcap -tttt -nn '{% set flow_parts = flow.flow_key.split(' ‚Üí ') %}{% set src_ip_port = flow_parts[0].split(':') %}{% set dst_ip_port = flow_parts[1].split(':') %}{% set tcpdump_filter_expr = 'host ' + src_ip_port[0] + ' and port ' + src_ip_port[1] + ' and host ' + dst_ip_port[0] + ' and port ' + dst_ip_port[1] %}{{ tcpdump_filter_expr }} and tcp[tcpflags] & tcp-rst != 0'</div>

                                            

                                                                            </div>

            

                                                                            <div class="filter-box">

            

                                                                                <span class="filter-label">üîç Filtre Wireshark (flux complet):</span>

            

                                                                                <div class="filter-command">ip.addr == {{ src_ip_port[0] }} && tcp.port == {{ src_ip_port[1] }} && ip.addr == {{ dst_ip_port[0] }} && tcp.port == {{ dst_ip_port[1] }}</div>

            

                                                                            </div>

                                        </div>

                                    </div>

                                </div>

                                {% endfor %}

                            </div>

                        </div>

                        {% endif %}
        </div>
        {% endif %}

        <!-- Fragmentation IP -->
        {% if ip_fragmentation.has_fragmentation %}
        <h2>
            üì¶ Analyse de la fragmentation IP
            <div class="info-tooltip">
                <span class="info-icon">i</span>
                <span class="tooltip-text">
                    <strong>üîç Fragmentation IP :</strong>
                    <br>Paquet > MTU r√©seau.
                    <br>‚Ä¢ Probl√®me : Fragments perdus = timeouts silencieux.
                    <br>‚Ä¢ Solution : Ajuster MSS, activer PMTU Discovery.
                </span>
            </div>
        </h2>
        <div class="section warning">
            <h3>{{ ip_fragmentation.total_fragments }} fragment(s) IP d√©tect√©(s)</h3>
            
            <div class="summary-grid">
                <div class="summary-card info">
                    <h4>Groupes de fragments</h4>
                    <div class="value">{{ ip_fragmentation.total_fragment_groups }}</div>
                    <small>Datagrammes fragment√©s</small>
                </div>
                <div class="summary-card success">
                    <h4>R√©assemblages complets</h4>
                    <div class="value">{{ ip_fragmentation.complete_reassemblies }}</div>
                    <small>Fragments re√ßus au complet</small>
                </div>
                <div class="summary-card danger">
                    <h4>R√©assemblages incomplets</h4>
                    <div class="value">{{ ip_fragmentation.incomplete_reassemblies }}</div>
                    <small>Fragments manquants</small>
                </div>
                <div class="summary-card info">
                    <h4>PMTU estim√©</h4>
                    <div class="value">{{ ip_fragmentation.estimated_pmtu }}</div>
                    <small>bytes</small>
                </div>
            </div>

            {% if ip_fragmentation.top_fragmented_flows and ip_fragmentation.top_fragmented_flows|length > 0 %}
            <h4>Top {{ ip_fragmentation.top_fragmented_flows|length }} des flux avec fragmentation:</h4>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>Fragments</th>
                        <th>Taux</th>
                        <th>Taille min/max/avg</th>
                        <th>Incomplets</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in ip_fragmentation.top_fragmented_flows[:10] %}
                    <tr>
                        <td><code>{{ flow.flow_key }}</code></td>
                        <td><strong>{{ flow.fragment_count }}</strong> / {{ flow.packets_count }}</td>
                        <td>
                            {% if flow.fragmentation_rate > 50 %}
                            <span class="badge danger">{{ "%.1f"|format(flow.fragmentation_rate) }}%</span>
                            {% elif flow.fragmentation_rate > 20 %}
                            <span class="badge warning">{{ "%.1f"|format(flow.fragmentation_rate) }}%</span>
                            {% else %}
                            <span class="badge info">{{ "%.1f"|format(flow.fragmentation_rate) }}%</span>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ flow.min_fragment_size }} / {{ flow.max_fragment_size }} / {{ "%.0f"|format(flow.avg_fragment_size) }} bytes</small>
                        </td>
                        <td>
                            {% if flow.incomplete_reassemblies > 0 %}
                            <span class="badge danger">{{ flow.incomplete_reassemblies }}</span>
                            {% else %}
                            <span class="badge success">0</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            {% if ip_fragmentation.incomplete_fragments_details and ip_fragmentation.incomplete_fragments_details|length > 0 %}
            <h4>‚ö†Ô∏è Fragments incomplets (possibles pertes):</h4>
            {% for frag in ip_fragmentation.incomplete_fragments_details[:10] %}
            <div class="detail-box">
                <div class="info-line">
                    <span class="info-label">Flux:</span>
                    <span class="info-value"><code>{{ frag.flow_key }}</code></span>
                </div>
                
                <div class="info-line">
                    <span class="info-label">ID Datagramme:</span>
                    <span class="info-value count">{{ frag.ip_id }}</span>
                </div>
                
                <div class="info-line">
                    <span class="info-label">Fragments re√ßus:</span>
                    <span class="info-value count">{{ frag.fragments_received }}</span>
                </div>
                
                {% if frag.total_length %}
                <div class="info-line">
                    <span class="info-label">Longueur totale attendue:</span>
                    <span class="info-value count">{{ frag.total_length }} bytes</span>
                </div>
                {% else %}
                <div class="info-line">
                    <span class="error-indicator">‚ö†Ô∏è Longueur totale inconnue (dernier fragment non re√ßu)</span>
                </div>
                {% endif %}
                
                <div class="info-line">
                    <span class="info-label">√Çge du fragment:</span>
                    <span class="info-value">{{ "%.1f"|format(frag.age) }}s</span>
                </div>
                
                <div class="filter-box">
                    <span class="filter-label">üîç Filtre tcpdump (fragments):</span>
                    <div class="filter-command">tcpdump -r file.pcap -tttt -nn 'ip[6:2] & 0x1fff != 0 and host {{ frag.src_ip }} and host {{ frag.dst_ip }}'</div>
                </div>

                <div class="filter-box">
                    <span class="filter-label">üîç Filtre Wireshark:</span>
                    <div class="filter-command">ip.src == {{ frag.src_ip }} && ip.dst == {{ frag.dst_ip }} && ip.id == {{ frag.ip_id }}</div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}

        <!-- RTT -->
        {% if rtt.flows_with_high_rtt > 0 %}
        <h2>‚è≤Ô∏è Analyse RTT (Round Trip Time)</h2>
        <div class="section warning">
            <h3>{{ rtt.flows_with_high_rtt }} flux avec RTT √©lev√©</h3>
            <p><strong>RTT moyen global:</strong> {{ "%.2f"|format((rtt.global_statistics.mean_rtt or 0) * 1000) }} ms</p>
            <p><strong>RTT max global:</strong> {{ "%.2f"|format((rtt.global_statistics.max_rtt or 0) * 1000) }} ms</p>

            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>RTT moyen</th>
                        <th>RTT min/max</th>
                        <th>Pics RTT</th>
                        <th>Mesures</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in rtt.flow_statistics[:15] %}
                    {% if flow.mean_rtt > rtt.thresholds.warning_seconds %}
                    <tr>
                        <td><code>{{ flow.flow_key }}</code></td>
                        <td><strong>{{ "%.2f"|format(flow.mean_rtt * 1000) }} ms</strong></td>
                        <td>{{ "%.2f"|format(flow.min_rtt * 1000) }} / {{ "%.2f"|format(flow.max_rtt * 1000) }} ms</td>
                        <td>{{ flow.rtt_spikes }}</td>
                        <td>{{ flow.measurements_count }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- TCP Window -->
        {% if tcp_window.flows_with_issues > 0 %}
        <h2>ü™ü Analyse des fen√™tres TCP</h2>
        <div class="section warning">
            <h3>{{ tcp_window.flows_with_issues }} flux avec probl√®mes de fen√™tre</h3>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>Goulot suspect√©</th>
                        <th>Zero Windows</th>
                        <th>Dur√©e ZW totale</th>
                        <th>Fen√™tre min/moy/max</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in tcp_window.flow_statistics[:15] %}
                    {% if flow.suspected_bottleneck != 'none' %}
                    <tr>
                        <td><code>{{ flow.flow_key }}</code></td>
                        <td>
                            {% if flow.suspected_bottleneck == 'application' %}
                            <span class="badge danger">Application</span>
                            {% elif flow.suspected_bottleneck == 'receiver' %}
                            <span class="badge warning">R√©cepteur</span>
                            {% else %}
                            <span class="badge info">{{ flow.suspected_bottleneck }}</span>
                            {% endif %}
                        </td>
                        <td>{{ flow.zero_window_count }}</td>
                        <td>{{ "%.3f"|format(flow.zero_window_total_duration) }}s</td>
                        <td>{{ flow.min_window }} / {{ "%.0f"|format(flow.mean_window) }} / {{ flow.max_window }} bytes</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- ICMP / PMTU -->
        {% if icmp.pmtu_issues_count > 0 or icmp.dest_unreachable_count > 0 %}
        <h2>üì° Analyse ICMP et PMTU</h2>

        {% if icmp.pmtu_issues_count > 0 %}
        <div class="section danger">
            <h3>üî¥ {{ icmp.pmtu_issues_count }} probl√®me(s) PMTU d√©tect√©(s)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Paquet</th>
                        <th>Message</th>
                        <th>MTU sugg√©r√©</th>
                        <th>Flux affect√©</th>
                    </tr>
                </thead>
                <tbody>
                    {% for msg in icmp.pmtu_issues %}
                    <tr>
                        <td>#{{ msg.packet_num }}</td>
                        <td>{{ msg.message }}</td>
                        <td>{% if msg.mtu > 0 %}<strong>{{ msg.mtu }} bytes</strong>{% else %}N/A{% endif %}</td>
                        <td><code>{{ msg.original_src }} ‚Üí {{ msg.original_dst }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if icmp.pmtu_suggestions %}
            <div class="suggestions">
                <h4>üí° Suggestions:</h4>
                <ul>
                    {% for suggestion in icmp.pmtu_suggestions %}
                    <li>{{ suggestion }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if icmp.dest_unreachable_count > 0 %}
        <div class="section warning">
            <h3>{{ icmp.dest_unreachable_count }} message(s) Destination Unreachable</h3>
            <p>Des destinations sont injoignables. V√©rifiez la configuration r√©seau et les pare-feu.</p>

            {% if icmp.top_unreachable_destinations %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üö´ Top 10 des destinations injoignables</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>Destination</th>
                                <th>Occurrences</th>
                                <th>Raison principale</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dest in icmp.top_unreachable_destinations %}
                            <tr>
                                <td><code>{{ dest.ip }}</code></td>
                                <td>{{ dest.count }}</td>
                                <td><span class="badge warning">{{ dest.reason }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}

        <!-- DNS -->
        {% if dns.timeout_transactions > 0 or dns.slow_transactions > 0 %}
        <h2>üåê Analyse DNS</h2>
        <div class="section {% if dns.timeout_transactions > 5 %}danger{% else %}warning{% endif %}">
            <h3>Probl√®mes DNS d√©tect√©s</h3>
            <p><strong>Requ√™tes totales:</strong> {{ dns.total_queries }}</p>
            <p><strong>Timeouts:</strong> {{ dns.timeout_transactions }}</p>
            <p><strong>R√©ponses lentes:</strong> {{ dns.slow_transactions }}</p>
            <p><strong>Erreurs:</strong> {{ dns.error_transactions }}</p>

            {% if dns.top_problematic_domains %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">‚ùå Domaines probl√©matiques (Top {{ dns.top_problematic_domains|length }})</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>Domaine</th>
                                <th>Nombre de probl√®mes</th>
                                <th>Type principal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in dns.top_problematic_domains %}
                            <tr>
                                <td><code>{{ item.domain }}</code></td>
                                <td>{{ item.count }}</td>
                                <td><span class="badge warning">{{ item.main_error }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Top Talkers -->
        {% if top_talkers.top_ips %}
        <h2>üìä Top Talkers - Analyse du volume</h2>
        <div class="section info">
            
            <div class="info-box">
                <p><strong>üîç Comprendre les Top Talkers :</strong></p>
                <ul>
                    <li><strong>Objectif :</strong> Identifier les h√¥tes (IP) et les conversations (flux) qui g√©n√®rent le plus grand volume de trafic.</li>
                    <li><strong>Utilit√© :</strong> Essentiel pour d√©tecter les applications gourmandes en bande passante, les transferts de fichiers importants, les √©ventuels abus (P2P), ou la source d'une saturation.</li>
                    <li><strong>Investigation :</strong> Corr√©lez les IPs et les ports avec les services connus et les propri√©taires des machines pour comprendre l'origine et la l√©gitimit√© du trafic.</li>
                </ul>
            </div>

            <!-- R√©partition par protocole -->
            {% if top_talkers.protocol_stats %}
            <h3>R√©partition par protocole</h3>
            <div class="summary-grid">
                {% for proto, stats in top_talkers.protocol_stats.items() %}
                <div class="summary-card {% if proto == 'TCP' %}info{% elif proto == 'UDP' %}success{% else %}warning{% endif %}">
                    <h4>{{ proto }}</h4>
                    <div class="value">{{ format_bytes(stats.bytes) }}</div>
                    <small>{{ stats.packets }} paquets</small>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Top IPs -->
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üíª Top 10 des h√¥tes par volume</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Adresse IP</th>
                                <th>Volume total</th>
                                <th>Envoy√©</th>
                                <th>Re√ßu</th>
                                <th>Paquets</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ip_stat in top_talkers.top_ips[:10] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><code>{{ ip_stat.ip }}</code></td>
                                <td><strong>{{ format_bytes(ip_stat.total_bytes) }}</strong></td>
                                <td>{{ format_bytes(ip_stat.bytes_sent) }}</td>
                                <td>{{ format_bytes(ip_stat.bytes_received) }}</td>
                                <td>{{ ip_stat.packets_sent + ip_stat.packets_received }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Conversations -->
            {% if top_talkers.top_conversations %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üó£Ô∏è Top 10 des conversations</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Source</th>
                                <th>Destination</th>
                                <th>Protocole</th>
                                <th>Volume</th>
                                <th>Paquets</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for conv in top_talkers.top_conversations[:10] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><code>{{ conv.src_ip }}{% if conv.src_port %}:{{ conv.src_port }}{% endif %}</code></td>
                                <td><code>{{ conv.dst_ip }}{% if conv.dst_port %}:{{ conv.dst_port }}{% endif %}</code></td>
                                <td><span class="badge {% if conv.protocol == 'TCP' %}info{% elif conv.protocol == 'UDP' %}success{% else %}warning{% endif %}">{{ conv.protocol }}</span></td>
                                <td><strong>{{ format_bytes(conv.bytes) }}</strong></td>
                                <td>{{ conv.packets }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Throughput -->
        {% if throughput.global_throughput %}
        <h2>üìà Analyse du d√©bit (Throughput)</h2>
        <div class="section info">
            
            <div class="info-box">
                <p><strong>üîç Comprendre le D√©bit (Throughput) :</strong></p>
                <ul>
                    <li><strong>D√©finition :</strong> Le d√©bit est la quantit√© de donn√©es transf√©r√©es par unit√© de temps (Mbps, Kbps).</li>
                    <li><strong>Objectif :</strong> Mesurer la performance r√©elle du r√©seau et identifier les goulots d'√©tranglement ou les congestions.</li>
                    <li><strong>Utilit√© :</strong> Une baisse inattendue du d√©bit peut indiquer un probl√®me r√©seau (congestion, c√¢ble d√©fectueux) ou un ralentissement applicatif (serveur lent, disque satur√©).</li>
                </ul>
            </div>

            <!-- Stats globales -->
            <div class="summary-grid">
                <div class="summary-card info">
                    <h4>D√©bit global</h4>
                    <div class="value">{{ "%.2f"|format(throughput.global_throughput.throughput_mbps) }} Mbps</div>
                    <small>{{ "%.2f"|format(throughput.global_throughput.throughput_kbps) }} Kbps</small>
                </div>
                <div class="summary-card success">
                    <h4>Volume total</h4>
                    <div class="value">{{ format_bytes(throughput.global_throughput.total_bytes) }}</div>
                    <small>{{ throughput.global_throughput.total_packets }} paquets</small>
                </div>
                <div class="summary-card info">
                    <h4>Dur√©e capture</h4>
                    <div class="value">{{ "%.1f"|format(throughput.global_throughput.duration_seconds) }}s</div>
                    <small>{{ throughput.total_flows }} flux</small>
                </div>
            </div>

            <!-- Top flows par d√©bit -->
            {% if throughput.top_flows %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üèÜ Top 10 des flux par d√©bit</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Flux</th>
                                <th>Protocole</th>
                                <th>D√©bit</th>
                                <th>Volume</th>
                                <th>Dur√©e</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for flow in throughput.top_flows[:10] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><code>{{ flow.src_ip }}:{% if flow.src_port %}{{ format_port(flow.src_port) }}{% endif %} <-> {{ flow.dst_ip }}:{% if flow.dst_port %}{{ format_port(flow.dst_port) }}{% endif %}</code></td>
                                <td><span class="badge {% if flow.protocol == 'TCP' %}info{% elif flow.protocol == 'UDP' %}success{% else %}warning{% endif %}">{{ flow.protocol }}</span></td>
                                <td><strong>{{ "%.2f"|format(flow.throughput_mbps) }} Mbps</strong></td>
                                <td>{{ format_bytes(flow.bytes) }}</td>
                                <td>
                                    {% if flow.duration_seconds < 0.01 %}
                                        &lt; 0.01s
                                    {% else %}
                                        {{ "%.2f"|format(flow.duration_seconds) }}s
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Flux lents -->
            {% if throughput.slow_flows %}
            <h3>‚ö†Ô∏è Flux √† faible d√©bit (potentiels goulots)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>D√©bit</th>
                        <th>Volume</th>
                        <th>Dur√©e</th>
                        <th>Taille moy. paquet</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in throughput.slow_flows %}
                    <tr>
                        <td><code>{{ flow.flow_key }}</code></td>
                        <td><span class="badge warning">{{ "%.2f"|format(flow.throughput_kbps) }} Kbps</span></td>
                        <td>{{ format_bytes(flow.bytes) }}</td>
                        <td>{{ "%.1f"|format(flow.duration_seconds) }}s</td>
                        <td>{{ "%.0f"|format(flow.avg_packet_size) }} bytes</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endif %}

        <!-- TCP Timeout -->
        {% if tcp_timeout and tcp_timeout.total_connections > 0 %}
        <h2>‚è±Ô∏è Analyse des Timeouts TCP</h2>
        <div class="section {% if tcp_timeout.problematic_count > 10 %}danger{% elif tcp_timeout.problematic_count > 0 %}warning{% else %}success{% endif %}">
            
            <div class="info-box">
                <p><strong>üîç Comprendre les Timeouts TCP :</strong></p>
                <ul>
                    <li><strong>D√©finition :</strong> Un timeout TCP se produit lorsqu'une connexion TCP attend une r√©ponse (ACK) qui ne vient pas dans un d√©lai raisonnable.</li>
                    <li><strong>Impact :</strong> Entra√Æne des retransmissions et des retards importants. Pour l'utilisateur, cela se traduit par des lenteurs, des √©crans blancs, ou des erreurs de connexion.</li>
                    <li><strong>Causes courantes :</strong> Perte de paquets (congestion, c√¢blage), serveurs satur√©s (ne r√©pondent pas √† temps), ou applications qui ne g√®rent pas correctement la fermeture des connexions.</li>
                </ul>
            </div>

            <!-- Stats globales -->
            <div class="summary-grid">
                <div class="summary-card info">
                    <h4>Connexions totales</h4>
                    <div class="value">{{ tcp_timeout.total_connections }}</div>
                </div>
                <div class="summary-card {% if tcp_timeout.problematic_count > 10 %}danger{% elif tcp_timeout.problematic_count > 0 %}warning{% else %}success{% endif %}">
                    <h4>Connexions probl√©matiques</h4>
                    <div class="value">{{ tcp_timeout.problematic_count }}</div>
                </div>
                <div class="summary-card success">
                    <h4>Ferm√©es proprement (FIN)</h4>
                    <div class="value">{{ tcp_timeout.categories.closed_fin_count }}</div>
                </div>
                <div class="summary-card info">
                    <h4>Ferm√©es par RST</h4>
                    <div class="value">{{ tcp_timeout.categories.closed_rst_count }}</div>
                    {% if tcp_timeout.categories.total_rst_packets is defined %}
                    <small>({{ tcp_timeout.categories.total_rst_packets }} paquets RST vus)</small>
                    {% endif %}
                </div>
            </div>

            <!-- D√©tails des probl√®mes -->
            {% if tcp_timeout.problematic_count > 0 %}
            <h3>üîç R√©partition des probl√®mes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Type de probl√®me</th>
                        <th>Description</th>
                        <th>Nombre</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge danger">SYN Timeout</span></td>
                        <td>SYN envoy√© mais pas de SYN-ACK re√ßu</td>
                        <td>{{ tcp_timeout.categories.syn_timeout_count }}</td>
                    </tr>
                    <tr>
                        <td><span class="badge warning">Half-Open</span></td>
                        <td>SYN-ACK re√ßu mais pas d'ACK final</td>
                        <td>{{ tcp_timeout.categories.half_open_count }}</td>
                    </tr>
                    <tr>
                        <td><span class="badge danger">Zombie</span></td>
                        <td>Inactives depuis >{{ tcp_timeout.thresholds.zombie_threshold }}s sans fermeture</td>
                        <td>{{ tcp_timeout.categories.zombie_count }}</td>
                    </tr>
                    <tr>
                        <td><span class="badge warning">Idle</span></td>
                        <td>Inactives depuis >{{ tcp_timeout.thresholds.idle_threshold }}s</td>
                        <td>{{ tcp_timeout.categories.idle_count }}</td>
                    </tr>
                    <tr>
                        <td><span class="badge info">√âtablies sans donn√©es</span></td>
                        <td>Handshake complet mais aucune donn√©e</td>
                        <td>{{ tcp_timeout.categories.established_idle_count }}</td>
                    </tr>
                </tbody>
            </table>
            {% endif %}

            <!-- SYN Timeout d√©tails -->
            {% if tcp_timeout.categories.syn_timeout and tcp_timeout.categories.syn_timeout|length > 0 %}
            <h3>üî¥ Connexions SYN Timeout (Top 10)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>Premier SYN</th>
                        <th>Dernier paquet</th>
                        <th>Temps d'attente</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conn in tcp_timeout.categories.syn_timeout %}
                    <tr>
                        <td><code>{{ conn.flow }}</code></td>
                        <td>{{ conn.first_seen_iso }}</td>
                        <td>{{ conn.last_seen_iso }}</td>
                        <td><span class="badge danger">{{ "%.1f"|format(conn.idle_time) }}s</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- Zombie d√©tails -->
            {% if tcp_timeout.categories.zombie and tcp_timeout.categories.zombie|length > 0 %}
            <h3>üíÄ Connexions Zombie (Top 10)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>Dur√©e active</th>
                        <th>Inactif depuis</th>
                        <th>Paquets</th>
                        <th>Volume</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conn in tcp_timeout.categories.zombie %}
                    <tr>
                        <td><code>{{ conn.flow }}</code></td>
                        <td>{{ "%.1f"|format(conn.duration) }}s</td>
                        <td><span class="badge danger">{{ "%.1f"|format(conn.idle_time) }}s</span></td>
                        <td>{{ conn.packet_count }}</td>
                        <td>{{ format_bytes(conn.bytes_total) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- Half-open d√©tails -->
            {% if tcp_timeout.categories.half_open and tcp_timeout.categories.half_open|length > 0 %}
            <h3>‚ö†Ô∏è Connexions Half-Open (Top 10)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>Premier SYN</th>
                        <th>Inactif depuis</th>
                        <th>√âtat</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conn in tcp_timeout.categories.half_open %}
                    <tr>
                        <td><code>{{ conn.flow }}</code></td>
                        <td>{{ conn.first_seen_iso }}</td>
                        <td><span class="badge warning">{{ "%.1f"|format(conn.idle_time) }}s</span></td>
                        <td>SYN-ACK re√ßu, en attente ACK</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endif %}

        <!-- Trafic Asym√©trique -->
        {% if asymmetric_traffic and asymmetric_traffic.summary.total_flows > 0 %}
        <h2>‚öñÔ∏è Analyse du Trafic Asym√©trique</h2>
        <div class="section {% if asymmetric_traffic.summary.asymmetric_flows > 50 %}danger{% elif asymmetric_traffic.summary.asymmetric_flows > 10 %}warning{% else %}success{% endif %}">
            
            <div class="info-box">
                <p><strong>üîç Comprendre le Trafic Asym√©trique :</strong></p>
                <ul>
                    <li><strong>D√©finition :</strong> Un flux est dit "asym√©trique" quand le volume de donn√©es envoy√© dans une direction est beaucoup plus important que dans l'autre.</li>
                    <li><strong>Normalit√© :</strong> C'est normal pour le t√©l√©chargement de fichiers (Download >> Upload) ou le streaming.</li>
                    <li><strong>Anomalie :</strong> C'est suspect pour des protocoles transactionnels sym√©triques, ou si le trafic est quasi-unidirectionnel (ratio &lt; 0.3), ce qui peut indiquer un probl√®me de routage, une perte de paquets de retour, ou un scan UDP.</li>
                </ul>
            </div>

            <!-- Stats globales -->
            <div class="summary-grid">
                <div class="summary-card info">
                    <h4>Flux analys√©s</h4>
                    <div class="value">{{ asymmetric_traffic.summary.total_flows }}</div>
                </div>
                <div class="summary-card {% if asymmetric_traffic.summary.asymmetric_flows > 50 %}danger{% elif asymmetric_traffic.summary.asymmetric_flows > 10 %}warning{% else %}success{% endif %}">
                    <h4>Flux asym√©triques</h4>
                    <div class="value">{{ asymmetric_traffic.summary.asymmetric_flows }} ({{ "%.1f"|format(asymmetric_traffic.summary.asymmetric_percentage) }}%)</div>
                </div>
                <div class="summary-card danger">
                    <h4>Quasi-unidirectionnels</h4>
                    <div class="value">{{ asymmetric_traffic.summary.unidirectional_flows }}</div>
                </div>
                <div class="summary-card success">
                    <h4>Flux sym√©triques</h4>
                    <div class="value">{{ asymmetric_traffic.summary.symmetric_flows }}</div>
                </div>
            </div>

            <p>Seuil d'asym√©trie: <strong>ratio < {{ asymmetric_traffic.summary.asymmetry_threshold }}</strong> (une direction a moins de {{ "%.0f"|format(asymmetric_traffic.summary.asymmetry_threshold * 100) }}% de l'autre)</p>

            <!-- R√©partition par protocole -->
            {% if asymmetric_traffic.protocol_breakdown %}
            <h3>üìä R√©partition par protocole</h3>
            <table>
                <thead>
                    <tr>
                        <th>Protocole</th>
                        <th>Flux</th>
                        <th>Volume</th>
                        <th>Asym√©triques</th>
                    </tr>
                </thead>
                <tbody>
                    {% for proto, stats in asymmetric_traffic.protocol_breakdown.items() %}
                    <tr>
                        <td><span class="badge">{{ proto }}</span></td>
                        <td>{{ stats.flows }}</td>
                        <td>{{ format_bytes(stats.bytes) }}</td>
                        <td>
                            {% if stats.asymmetric > 0 %}
                            <span class="badge warning">{{ stats.asymmetric }}</span>
                            {% else %}
                            <span class="badge success">0</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- Top flux par volume -->
            {% if asymmetric_traffic.top_flows_by_volume %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üìà Top 10 flux par volume</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>Flux</th>
                                <th>Protocole</th>
                                <th>Volume total</th>
                                <th>Forward ‚Üí</th>
                                <th>‚Üê Reverse</th>
                                <th>Asym√©trie</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for flow in asymmetric_traffic.top_flows_by_volume[:10] %}
                            <tr>
                                <td><code>{{ flow.src_ip }} ‚Üî {{ flow.dst_ip }}</code></td>
                                <td><span class="badge">{{ flow.protocol }}</span></td>
                                <td>{{ format_bytes(flow.total_bytes) }}</td>
                                <td>{{ format_bytes(flow.forward_bytes) }}</td>
                                <td>{{ format_bytes(flow.reverse_bytes) }}</td>
                                <td>
                                    {% if flow.asymmetry_percent > 90 %}
                                    <span class="badge danger">{{ "%.1f"|format(flow.asymmetry_percent) }}%</span>
                                    {% elif flow.asymmetry_percent > 70 %}
                                    <span class="badge warning">{{ "%.1f"|format(flow.asymmetry_percent) }}%</span>
                                    {% else %}
                                    <span class="badge success">{{ "%.1f"|format(flow.asymmetry_percent) }}%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Flux les plus asym√©triques -->
            {% if asymmetric_traffic.asymmetric_flows %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üî¥ Flux les plus asym√©triques (Top 20)</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>Flux</th>
                                <th>Proto</th>
                                <th>Direction dominante</th>
                                <th>Forward</th>
                                <th>Reverse</th>
                                <th>Ratio</th>
                                <th>Asym√©trie</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for flow in asymmetric_traffic.asymmetric_flows[:20] %}
                            <tr>
                                <td><code>{{ flow.src_ip }}:{{ flow.src_port }} ‚Üî {{ flow.dst_ip }}:{{ flow.dst_port }}</code></td>
                                <td><span class="badge">{{ flow.protocol }}</span></td>
                                <td>
                                    {% if flow.dominant_direction == 'forward' %}
                                    <span class="badge info">{{ flow.src_ip }} ‚Üí</span>
                                    {% else %}
                                    <span class="badge info">‚Üê {{ flow.dst_ip }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ format_bytes(flow.forward_bytes) }} ({{ flow.forward_packets }} pkts)</td>
                                <td>{{ format_bytes(flow.reverse_bytes) }} ({{ flow.reverse_packets }} pkts)</td>
                                <td>{{ "%.4f"|format(flow.byte_ratio) }}</td>
                                <td>
                                    {% if flow.is_unidirectional %}
                                    <span class="badge danger">{{ "%.1f"|format(flow.asymmetry_percent) }}% (Unidirectionnel)</span>
                                    {% else %}
                                    <span class="badge warning">{{ "%.1f"|format(flow.asymmetry_percent) }}%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Bursts de Paquets -->
        {% if burst and burst.summary.total_intervals > 0 %}
        <h2>üí• Analyse des Bursts de Paquets</h2>
        <div class="section {% if burst.summary.bursts_detected > 10 %}danger{% elif burst.summary.bursts_detected > 0 %}warning{% else %}success{% endif %}">
            
            <div class="info-box">
                <p><strong>üîç Comprendre les Bursts :</strong></p>
                <ul>
                    <li><strong>D√©finition :</strong> Un "burst" (rafale) est une augmentation soudaine et massive du trafic sur un intervalle tr√®s court (ici 100ms).</li>
                    <li><strong>Impact :</strong> Ces micro-congestions invisibles sur les graphiques √† la minute peuvent saturer les buffers des switchs et causer des pertes de paquets al√©atoires.</li>
                    <li><strong>Seuil :</strong> Un ratio > 10x la moyenne est consid√©r√© comme risqu√©.</li>
                </ul>
            </div>

            <!-- Stats globales -->
            <div class="summary-grid">
                <div class="summary-card info">
                    <h4>Intervalles analys√©s</h4>
                    <div class="value">{{ burst.summary.total_intervals }}</div>
                    <small>{{ burst.summary.interval_ms }}ms par intervalle</small>
                </div>
                <div class="summary-card {% if burst.summary.bursts_detected > 10 %}danger{% elif burst.summary.bursts_detected > 0 %}warning{% else %}success{% endif %}">
                    <h4>Bursts d√©tect√©s</h4>
                    <div class="value">{{ burst.summary.bursts_detected }}</div>
                    <small>Seuil: {{ burst.summary.burst_threshold_multiplier }}x la moyenne</small>
                </div>
                <div class="summary-card info">
                    <h4>Paquets dans bursts</h4>
                    <div class="value">{{ burst.summary.packets_in_bursts }}</div>
                </div>
                <div class="summary-card {% if burst.interval_stats.traffic_regularity == 'Tr√®s irr√©gulier' %}danger{% elif burst.interval_stats.traffic_regularity == 'Variable' %}warning{% else %}success{% endif %}">
                    <h4>R√©gularit√© du trafic</h4>
                    <div class="value">{{ burst.interval_stats.traffic_regularity }}</div>
                    <small>CV: {{ burst.interval_stats.coefficient_of_variation }}%</small>
                </div>
            </div>

            <!-- Statistiques d'intervalle -->
            <h3>üìä Distribution du trafic</h3>
            <table>
                <thead>
                    <tr>
                        <th>M√©trique</th>
                        <th>Valeur</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            Activit√© moyenne (paquets/intervalle)
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    Nombre moyen de paquets observ√©s dans chaque intervalle de {{ burst.summary.interval_ms }}ms. Repr√©sente le niveau de trafic de fond.
                                </span>
                            </div>
                        </td>
                        <td>{{ burst.interval_stats.avg_packets_per_interval }}</td>
                    </tr>
                    <tr>
                        <td>
                            Activit√© minimale (paquets/intervalle)
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    Nombre minimal de paquets observ√©s dans un intervalle de {{ burst.summary.interval_ms }}ms. Peut indiquer des pauses ou des p√©riodes creuses.
                                </span>
                            </div>
                        </td>
                        <td>{{ burst.interval_stats.min_packets_per_interval }}</td>
                    </tr>
                    <tr>
                        <td>
                            Pic d'activit√© (Max)
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    Nombre maximal de paquets observ√©s dans un seul intervalle de {{ burst.summary.interval_ms }}ms. Indique le volume de trafic le plus √©lev√©.
                                </span>
                            </div>
                        </td>
                        <td><span class="badge {% if burst.interval_stats.max_packets_per_interval > burst.interval_stats.avg_packets_per_interval * 3 %}danger{% else %}info{% endif %}">{{ burst.interval_stats.max_packets_per_interval }}</span></td>
                    </tr>
                    <tr>
                        <td>
                            √âcart-type
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    Mesure la dispersion du nombre de paquets autour de la moyenne. Un √©cart-type √©lev√© indique un trafic irr√©gulier.
                                </span>
                            </div>
                        </td>
                        <td>{{ burst.interval_stats.std_deviation }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- Pire burst -->
            {% if burst.worst_burst %}
            <h3>üî¥ Burst le plus intense</h3>
            <div class="summary-grid">
                <div class="summary-card danger">
                    <h4>Timestamp</h4>
                    <div class="value">{{ burst.worst_burst.start_iso }}</div>
                </div>
                <div class="summary-card danger">
                    <h4>Paquets</h4>
                    <div class="value">{{ burst.worst_burst.packet_count }}</div>
                    <small>{{ burst.worst_burst.packets_per_second }} pkt/s</small>
                </div>
                <div class="summary-card warning">
                    <h4>Intensit√©</h4>
                    <div class="value">{{ burst.worst_burst.peak_ratio }}x</div>
                    <small>par rapport √† la moyenne</small>
                </div>
                {% if burst.worst_burst.top_source %}
                <div class="summary-card info">
                    <h4>Source principale</h4>
                    <div class="value" style="font-size: 0.9em">{{ burst.worst_burst.top_source.ip }}</div>
                    <small>{{ burst.worst_burst.top_source.packets }} paquets</small>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Liste des bursts -->
            {% if burst.bursts %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üìã Tous les bursts d√©tect√©s (Top 10)</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>D√©but</th>
                                <th>Dur√©e</th>
                                <th>Paquets</th>
                                <th>D√©bit</th>
                                <th>Intensit√©</th>
                                <th>Source principale</th>
                                <th>Protocoles</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in burst.bursts[:10] %}
                            <tr>
                                <td><code>{{ b.start_iso }}</code></td>
                                <td>{{ b.duration_ms }} ms</td>
                                <td>{{ b.packet_count }}</td>
                                <td>
                                    <span class="badge info">{{ b.packets_per_second }} pkt/s</span>
                                    <br><small>{{ b.mbps }} Mbps</small>
                                </td>
                                <td>
                                    {% if b.peak_ratio > 5 %}
                                    <span class="badge danger">{{ b.peak_ratio }}x</span>
                                    {% elif b.peak_ratio > 3 %}
                                    <span class="badge warning">{{ b.peak_ratio }}x</span>
                                    {% else %}
                                    <span class="badge info">{{ b.peak_ratio }}x</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if b.top_sources %}
                                    {{ b.top_sources[0].ip }} ({{ b.top_sources[0].packets }})
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {% for proto, count in b.protocol_breakdown.items() %}
                                    <span class="badge">{{ proto }}: {{ count }}</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Patterns Temporels -->
        {% if temporal and temporal.summary.total_slots > 0 %}
        <h2>üìÖ Analyse des Patterns Temporels</h2>
        <div class="section">
            
            <div class="info-box">
                <p><strong>üîç Comprendre les Patterns Temporels :</strong></p>
                <ul>
                    <li><strong>Objectif :</strong> D√©tecter des comportements p√©riodiques (machines) ou des tendances humaines (pics/creux).</li>
                    <li><strong>P√©riodicit√© :</strong> Indique souvent un script de monitoring, un heartbeat, une t√¢che cron ou une synchronisation automatique. Utile pour identifier du "bruit de fond" non-humain.</li>
                    <li><strong>Pics/Creux :</strong> Permettent de corr√©ler des incidents ou de planifier des maintenances aux heures creuses.</li>
                </ul>
            </div>

            <!-- Stats globales -->
            <div class="summary-grid">
                <div class="summary-card info">
                    <h4>P√©riode d'analyse</h4>
                    <div class="value" style="font-size: 0.8em">{{ temporal.summary.capture_start }}</div>
                    <small>‚Üí {{ temporal.summary.capture_end }}</small>
                </div>
                <div class="summary-card info">
                    <h4>Cr√©neaux analys√©s</h4>
                    <div class="value">{{ temporal.summary.total_slots }}</div>
                    <small>{{ temporal.summary.slot_duration_seconds }}s par cr√©neau</small>
                </div>
                <div class="summary-card {% if temporal.summary.peaks_detected > 10 %}warning{% else %}success{% endif %}">
                    <h4>Pics d√©tect√©s</h4>
                    <div class="value">{{ temporal.summary.peaks_detected }}</div>
                </div>
                <div class="summary-card {% if temporal.summary.periodic_patterns_detected > 0 %}warning{% else %}info{% endif %}">
                    <h4>Patterns p√©riodiques</h4>
                    <div class="value">{{ temporal.summary.periodic_patterns_detected }}</div>
                </div>
            </div>

            <!-- Statistiques par cr√©neau -->
            <h3>üìä Distribution du trafic</h3>
            <table>
                <thead>
                    <tr>
                        <th>M√©trique</th>
                        <th>Valeur</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            Activit√© moyenne (paquets/cr√©neau)
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    Nombre moyen de paquets observ√©s dans chaque cr√©neau de {{ temporal.summary.slot_duration_seconds }}s. Repr√©sente le niveau de trafic moyen sur la p√©riode.
                                </span>
                            </div>
                        </td>
                        <td>{{ temporal.slot_stats.avg_packets_per_slot }}</td>
                    </tr>
                    <tr>
                        <td>
                            Activit√© minimale (paquets/cr√©neau)
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    Nombre minimal de paquets observ√©s dans un cr√©neau de {{ temporal.summary.slot_duration_seconds }}s. Peut identifier les p√©riodes de faible activit√©.
                                </span>
                            </div>
                        </td>
                        <td>{{ temporal.slot_stats.min_packets_per_slot }}</td>
                    </tr>
                    <tr>
                        <td>Pic d'activit√© (Max)</td>
                        <td><span class="badge {% if temporal.slot_stats.peak_to_avg_ratio > 3 %}danger{% else %}info{% endif %}">{{ temporal.slot_stats.max_packets_per_slot }}</span></td>
                    </tr>
                    <tr>
                        <td>
                            Ratio pic/moyenne
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">
                                    Rapport entre le pic d'activit√© (max) et l'activit√© moyenne. Un ratio √©lev√© indique une grande variabilit√© du trafic.
                                </span>
                            </div>
                        </td>
                        <td>{{ temporal.slot_stats.peak_to_avg_ratio }}x</td>
                    </tr>
                </tbody>
            </table>

            <!-- Distribution horaire -->
            {% if temporal.hourly_distribution %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üïê Distribution horaire</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>Heure</th>
                                <th>Paquets</th>
                                <th>Volume</th>
                                <th>Moy/cr√©neau</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hour in temporal.hourly_distribution %}
                            <tr>
                                <td><code>{{ hour.hour_label }}</code></td>
                                <td>{{ hour.packets }}</td>
                                <td>{{ format_bytes(hour.bytes) }}</td>
                                <td>{{ hour.avg_per_slot }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Pics de trafic -->
            {% if temporal.peaks %}
            <div class="collapsible-header">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="header-title">üìà Pics de trafic (Top 10)</span>
            </div>
            <div class="collapsible-content">
                <div class="content-inner">
                    <table>
                        <thead>
                            <tr>
                                <th>Heure</th>
                                <th>Paquets</th>
                                <th>Volume</th>
                                <th>Ratio</th>
                                <th>Sources uniques</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for peak in temporal.peaks[:10] %}
                            <tr>
                                <td><code>{{ peak.time }}</code></td>
                                <td>{{ peak.packets }}</td>
                                <td>{{ format_bytes(peak.bytes) }}</td>
                                <td><span class="badge danger">{{ peak.ratio }}x</span></td>
                                <td>{{ peak.unique_sources }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Patterns p√©riodiques -->
            {% if temporal.periodic_patterns %}
            <h3>üîÑ Patterns p√©riodiques d√©tect√©s</h3>
            <p>Ces patterns indiquent des communications r√©guli√®res (heartbeat, polling, cron jobs, etc.)</p>
            <table>
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Intervalle</th>
                        <th>Description</th>
                        <th>Occurrences</th>
                        <th>Confiance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pattern in temporal.periodic_patterns %}
                    <tr>
                        <td><code>{{ pattern.source_ip }}</code></td>
                        <td>{{ pattern.interval_seconds }}s</td>
                        <td>{{ pattern.description }}</td>
                        <td>{{ pattern.occurrences }}</td>
                        <td>
                            {% if pattern.confidence >= 70 %}
                            <span class="badge success">{{ pattern.confidence }}%</span>
                            {% elif pattern.confidence >= 50 %}
                            <span class="badge warning">{{ pattern.confidence }}%</span>
                            {% else %}
                            <span class="badge info">{{ pattern.confidence }}%</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- Creux de trafic -->
            {% if temporal.valleys %}
            <h3>üìâ Creux de trafic</h3>
            <p>P√©riodes de faible activit√© - opportunit√© pour maintenance</p>
            <table>
                <thead>
                    <tr>
                        <th>Heure</th>
                        <th>Paquets</th>
                        <th>Ratio vs moyenne</th>
                    </tr>
                </thead>
                <tbody>
                    {% for valley in temporal.valleys[:5] %}
                    <tr>
                        <td><code>{{ valley.time }}</code></td>
                        <td>{{ valley.packets }}</td>
                        <td><span class="badge success">{{ valley.ratio }}x</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
        {% endif %}

        <!-- Section SACK/D-SACK (Priorit√© #10) -->
        {% if sack and sack.summary.tcp_packets > 0 %}
        <div class="section">
            <h2><span class="icon">üîÑ</span> SACK/D-SACK Analysis</h2>
            <p>Analyse des accus√©s de r√©ception s√©lectifs (Selective Acknowledgment)</p>
            
            <!-- Cartes de r√©sum√© -->
            <div class="summary-cards">
                <div class="summary-card {% if sack.summary.sack_usage_percentage < 10 %}warning{% elif sack.summary.sack_usage_percentage == 0 %}info{% else %}success{% endif %}">
                    <div class="label">üéØ Utilisation SACK</div>
                    <div class="value">{{ sack.summary.sack_usage_percentage }}%</div>
                    <small>{{ sack.summary.sack_packets }} / {{ sack.summary.tcp_packets }} paquets TCP</small>
                </div>
                <div class="summary-card {% if sack.summary.dsack_ratio_percentage > 5 %}danger{% else %}info{% endif %}">
                    <div class="label">‚ö†Ô∏è Ratio D-SACK</div>
                    <div class="value">{{ sack.summary.dsack_ratio_percentage }}%</div>
                    <small>{{ sack.summary.dsack_packets }} doublons d√©tect√©s</small>
                </div>
                <div class="summary-card info">
                    <div class="label">üåê Flux SACK</div>
                    <div class="value">{{ sack.summary.flows_using_sack }}</div>
                    <small>connexions utilisant SACK</small>
                </div>
                <div class="summary-card success">
                    <div class="label">üíæ √âconomie estim√©e</div>
                    <div class="value">{{ sack.efficiency.estimated_retransmission_savings_mb }} MB</div>
                    <small>retransmissions √©vit√©es</small>
                </div>
            </div>

            <!-- Efficacit√© SACK -->
            <h3>üìä Efficacit√© des retransmissions s√©lectives</h3>
            <table>
                <thead>
                    <tr>
                        <th>M√©trique</th>
                        <th>Valeur</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Octets SACK moyens</strong></td>
                        <td><span class="badge info">{{ sack.efficiency.avg_sacked_bytes_per_event }}</span></td>
                        <td>Taille moyenne des blocs acquitt√©s s√©lectivement</td>
                    </tr>
                    <tr>
                        <td><strong>Flux avec D-SACK</strong></td>
                        <td><span class="badge {% if sack.efficiency.flows_with_dsack > 0 %}warning{% else %}success{% endif %}">{{ sack.efficiency.flows_with_dsack }}</span></td>
                        <td>Connexions avec doublons ({{ sack.efficiency.dsack_flows_percentage }}%)</td>
                    </tr>
                    <tr>
                        <td><strong>Total √©v√©nements SACK</strong></td>
                        <td><span class="badge info">{{ sack.summary.total_sack_events }}</span></td>
                        <td>Nombre total d'accus√©s de r√©ception s√©lectifs</td>
                    </tr>
                </tbody>
            </table>

            <!-- Top flux SACK -->
            {% if sack.top_sack_flows and sack.summary.sack_packets > 0 %}
            <h3>üîù Top flux utilisant SACK</h3>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>√âv√©nements SACK</th>
                        <th>D-SACK</th>
                        <th>Octets SACK</th>
                        <th>Blocs uniques</th>
                        <th>Dur√©e</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in sack.top_sack_flows[:10] %}
                    <tr>
                        <td><code>{{ flow.src_ip }}:{{ format_port(flow.src_port) }} ‚Üî {{ flow.dst_ip }}:{{ format_port(flow.dst_port) }}</code></td>
                        <td><span class="badge info">{{ flow.sack_events }}</span></td>
                        <td>
                            {% if flow.dsack_events > 0 %}
                                <span class="badge danger">{{ flow.dsack_events }} ({{ flow.dsack_ratio }}%)</span>
                            {% else %}
                                <span class="badge success">0</span>
                            {% endif %}
                        </td>
                        <td>{{ format_bytes(flow.sacked_bytes) }}</td>
                        <td>{{ flow.unique_blocks }}</td>
                        <td>{{ flow.duration_seconds }}s</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- Flux probl√©matiques avec D-SACK -->
            {% if sack.dsack_analysis.problematic_flows and sack.summary.dsack_packets > 0 %}
            <h3>‚ö†Ô∏è Flux avec D-SACK (probl√©matiques)</h3>
            <p class="warning-note">D-SACK indique des doublons ou des retransmissions inutiles</p>
            <table>
                <thead>
                    <tr>
                        <th>Flux</th>
                        <th>D-SACK Events</th>
                        <th>Total SACK Events</th>
                        <th>% D-SACK</th>
                        <th>Probl√®me potentiel</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in sack.dsack_analysis.problematic_flows %}
                    <tr class="{% if flow.dsack_percentage > 10 %}danger{% else %}warning{% endif %}">
                        <td><code>{{ flow.src_ip }}:{{ format_port(flow.src_port) }} ‚Üî {{ flow.dst_ip }}:{{ format_port(flow.dst_port) }}</code></td>
                        <td><span class="badge danger">{{ flow.dsack_events }}</span></td>
                        <td>{{ flow.total_sack_events }}</td>
                        <td>{{ flow.dsack_percentage }}%</td>
                        <td>
                            {% if flow.dsack_percentage > 20 %}
                                <small>Retransmissions excessives</small>
                            {% elif flow.dsack_percentage > 10 %}
                                <small>Retransmissions fr√©quentes</small>
                            {% else %}
                                <small>Retransmissions occasionnelles</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- √âv√©nements SACK r√©cents -->
            {% if sack.recent_sack_events and sack.summary.sack_packets > 0 %}
            <h3>üïí √âv√©nements SACK r√©cents</h3>
            <table>
                <thead>
                    <tr>
                        <th>Heure</th>
                        <th>Flux</th>
                        <th>Blocs SACK</th>
                        <th>Octets</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in sack.recent_sack_events %}
                    <tr class="{% if event.is_dsack %}warning{% endif %}">
                        <td><code>{{ event.time }}</code></td>
                        <td><small>{{ event.flow }}</small></td>
                        <td>
                            {% for block in event.blocks %}
                                <span class="badge secondary">{{ block }}</span>
                            {% endfor %}
                            {% if event.blocks|length > 3 %}...{% endif %}
                        </td>
                        <td>{{ event.sacked_bytes }} B</td>
                        <td>
                            {% if event.is_dsack %}
                                <span class="badge danger" title="Duplicate SACK - s√©quence {{ event.dsack_sequence }}">D-SACK</span>
                            {% else %}
                                <span class="badge success">SACK</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            <!-- Recommandations -->
            <h3>üí° Recommandations</h3>
            <div class="detail-box">
                <ul>
                    {% if sack.summary.sack_usage_percentage == 0 %}
                    <li><strong>Aucune utilisation SACK d√©tect√©e</strong> - Les endpoints n'utilisent pas les retransmissions s√©lectives</li>
                    <li>SACK permet d'optimiser les retransmissions en acquittant s√©lectivement les segments re√ßus</li>
                    <li>V√©rifiez la configuration TCP des endpoints pour activer SACK si n√©cessaire</li>
                    {% elif sack.summary.sack_usage_percentage < 10 %}
                    <li><strong>Faible utilisation SACK ({{ sack.summary.sack_usage_percentage }}%)</strong> - V√©rifiez la configuration TCP des endpoints</li>
                    {% endif %}
                    {% if sack.efficiency.flows_with_dsack > 0 %}
                    <li><strong>{{ sack.efficiency.flows_with_dsack }} flux avec D-SACK</strong> - Investiguer les causes des retransmissions inutiles</li>
                    {% endif %}
                    {% if sack.summary.sack_packets > 0 %}
                    <li>SACK permet d'√©viter environ {{ sack.efficiency.estimated_retransmission_savings_mb }} MB de retransmissions compl√®tes</li>
                    <li>Surveillance recommand√©e des flux avec ratio D-SACK > 10%</li>
                    {% else %}
                    <li>SACK n'est pas utilis√© dans cette capture - retransmissions classiques en cas de perte</li>
                    {% endif %}
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- R√©sum√© interpr√©tatif pour non-techniciens -->
        <div class="section">
            <h2>üìã R√©sum√© interpr√©tatif</h2>
            <div class="summary-card">
                <h3>R√©sum√© pour les √©quipes m√©tier et management</h3>
                <div class="interpretive-summary">
                    {% set has_incident = false %}
                    {% set is_app_pause = false %}

                    {# Logique contextuelle am√©lior√©e : ne pas alarmer sur patterns r√©guliers #}
                    {# Utilise non_periodic_gaps au lieu de gaps_detected total #}
                    {# Correction : Ne d√©clenche incident sur les gaps QUE s'il y a des RTOs associ√©s (sinon c'est une pause applicative) #}
                    {% if timestamps and timestamps.get('non_periodic_gaps', timestamps['gaps_detected']) > 10 and not analysis_info.is_very_small_capture and retransmission and retransmission.rto_count > 0 %}
                        {% set has_incident = true %}
                    {% endif %}
                    {# Retransmissions : seuils RTO uniquement (Fast Retrans ne sont pas des incidents) #}
                    {# RTO > 0.5% indique un probl√®me r√©seau s√©v√®re (timeouts) #}
                    {% if retransmission and (analysis_info.rto_rate > 0.5 or retransmission.rto_count > 100) %}
                        {% set has_incident = true %}
                    {% endif %}
                    {# D√©bit < 0.1 Mbps n'est un probl√®me QUE si volume significatif ET pas de pattern p√©riodique #}
                    {% if throughput and throughput.global_throughput.throughput_mbps < 0.1 and analysis_info.total_packets > 10000 and not timestamps.get('periodic_pattern_detected', false) %}
                        {% set has_incident = true %}
                    {% endif %}
                    {# D√©tection de pause applicative : gaps sans RTO #}
                    {% if timestamps and timestamps['gaps_detected'] > 0 and retransmission and retransmission.rto_count == 0 and not analysis_info.is_very_small_capture %}
                        {% set is_app_pause = true %}
                    {% endif %}

                    {% if has_incident %}
                    <div class="alert alert-danger">
                        <h4>üö® Incident d√©tect√©</h4>
                        <p>Il y a un probl√®me de performance r√©seau qui impacte probablement l'exp√©rience utilisateur.</p>
                    </div>
                    {% elif is_app_pause %}
                    <div class="alert alert-info">
                        <h4>‚è∏Ô∏è Pause Applicative Probable</h4>
                        <p>Des p√©riodes de silence ont √©t√© d√©tect√©es, mais sans timeouts r√©seau (RTO). Ceci indique que le r√©seau √©tait disponible mais que l'application (ou l'utilisateur) ne transmettait pas de donn√©es.</p>
                    </div>
                    {% else %}
                    <div class="alert alert-success">
                        <h4>‚úÖ Aucun incident critique</h4>
                        <p>Le r√©seau fonctionne normalement selon les seuils d√©finis.</p>
                    </div>
                    {% endif %}

                    <div class="interpretation-details">
                        <h4>üîç Analyse des probl√®mes identifi√©s :</h4>
                        <ul>
                            {% if timestamps and timestamps['gaps_detected'] > 0 and (not timestamps.get('periodic_pattern_detected', false) or timestamps.get('non_periodic_gaps', 0) > 0) %}
                            <li><strong>D√©lais entre paquets :</strong> {{ timestamps.get('non_periodic_gaps', timestamps['gaps_detected']) }} p√©riodes de silence d√©tect√©es.
                                {% if analysis_info.is_very_small_capture %}
                                    Pour une capture de faible volume, ceci est normal (trafic sporadique).
                                {% elif retransmission and retransmission.rto_count == 0 %}
                                    <br><span class="badge success">‚úÖ Pause Applicative Probable :</span> Ces interruptions ne sont pas accompagn√©es de timeouts (RTO). Cela indique que le r√©seau √©tait disponible mais que l'application (ou l'utilisateur) ne transmettait pas de donn√©es (traitement, attente, script). <strong>Ce n'est pas un incident r√©seau.</strong>
                                {% elif timestamps.get('non_periodic_gaps', timestamps['gaps_detected']) > 10 %}
                                    Volume significatif d'interruptions avec retransmissions associ√©es - √† surveiller (instabilit√© r√©seau possible).
                                {% else %}
                                    Trafic non continu - v√©rifier si cela correspond au comportement attendu.
                                {% endif %}</li>
                            {% endif %}

                            {% if retransmission and retransmission.total_retransmissions > 0 %}
                            <li><strong>Retransmissions TCP :</strong> {{ retransmission.total_retransmissions }} paquets retransmis.

                                {% if analysis_info.rto_rate > 0.5 or retransmission.rto_count > 100 %}
                                    <br><span class="text-danger">üî¥ <strong>Critique :</strong> {{ retransmission.rto_count }} RTOs d√©tect√©s ({{ "%.2f"|format(analysis_info.rto_rate) }}%).</span> Volume √©lev√© de timeouts : indique une congestion s√©v√®re ou une connectivit√© instable.
                                {% elif analysis_info.rto_rate > 0.05 or retransmission.rto_count > 5 %}
                                    <br><span class="text-warning">‚ö†Ô∏è <strong>Attention :</strong> {{ retransmission.rto_count }} RTO(s) d√©tect√©(s) ({{ "%.2f"|format(analysis_info.rto_rate) }}%).</span> Quelques d√©lais d'attente importants. Impact ponctuel.
                                {% elif retransmission.rto_count > 0 %}
                                    <br><span class="text-success">‚ÑπÔ∏è <strong>Note :</strong> {{ retransmission.rto_count }} RTO d√©tect√© ({{ "%.2f"|format(analysis_info.rto_rate) }}%).</span> Volume n√©gligeable, sans impact perceptible.
                                {% elif retransmission.total_retransmissions > 5000 %}
                                    C'est un volume tr√®s √©lev√© qui indique des pertes de paquets fr√©quentes.
                                {% else %}
                                    Volume mod√©r√© de pertes de paquets (Fast Retransmissions), g√©n√©ralement g√©r√© par TCP sans impact majeur.
                                {% endif %}</li>
                            {% endif %}

                            {% if throughput and throughput.global_throughput.throughput_mbps %}
                            <li><strong>D√©bit global :</strong>
                                {{ format_bitrate(throughput.global_throughput.throughput_mbps) }}
                                sur {{ "%.0f"|format(throughput.global_throughput.duration_seconds / 60) }} minutes.
                                {% if analysis_info.is_very_small_capture %}
                                    Capture de faible volume ({{ analysis_info.total_packets }} paquets) - m√©trique de d√©bit non significative.
                                {% elif throughput.global_throughput.throughput_mbps < 1 and analysis_info.total_packets > 10000 %}
                                    D√©bit tr√®s faible pour ce volume de paquets - √† investiguer.
                                {% elif throughput.global_throughput.throughput_mbps < 10 %}
                                    D√©bit mod√©r√©.
                                {% else %}
                                    D√©bit satisfaisant.
                                {% endif %}</li>
                            {% endif %}

                            {% if tcp_timeout and tcp_timeout.total_connections > 0 %}
                            <li><strong>Connexions TCP :</strong> {{ tcp_timeout.total_connections }} connexions analys√©es, 
                                {% if tcp_timeout.problematic_count == 0 %}aucune n'est probl√©matique.{% else %}{{ tcp_timeout.problematic_count }} pr√©sentent des anomalies (timeouts, fermetures brutales).{% endif %}</li>
                            {% endif %}

                            {% if asymmetric_traffic and asymmetric_traffic.summary.unidirectional_flows > 0 %}
                            <li><strong>Trafic Unidirectionnel :</strong> {{ asymmetric_traffic.summary.unidirectional_flows }} flux unidirectionnels d√©tect√©s.
                                {% set mdns_found = false %}
                                {% set multicast_found = false %}
                                {% for flow in asymmetric_traffic.asymmetric_flows %}
                                    {% if flow.is_unidirectional %}
                                        {% if '5353' in flow.src_port|string or '5353' in flow.dst_port|string %}{% set mdns_found = true %}{% endif %}
                                        {% if flow.dst_ip.startswith('224.') or flow.dst_ip.startswith('239.') %}{% set multicast_found = true %}{% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if mdns_found or multicast_found %}
                                    <br>üîç <em>Analyse :</em> Ce trafic correspond principalement √† des protocoles de d√©couverte r√©seau (<strong>{% if mdns_found %}mDNS{% endif %}{% if mdns_found and multicast_found %}/{% endif %}{% if multicast_found %}Multicast{% endif %}</strong>). C'est un comportement <strong>normal</strong> o√π les √©metteurs envoient des annonces sans attendre de r√©ponse directe dans le m√™me flux. Ce n'est pas une anomalie.
                                {% else %}
                                    <br>‚ö†Ô∏è √Ä v√©rifier : S'il s'agit de trafic UDP autre que multicast, cela pourrait indiquer du streaming sans voie de retour visible ou une configuration de routage asym√©trique.
                                {% endif %}
                            </li>
                            {% endif %}

                            {% if dns and dns.error_transactions > 0 %}
                            <li><strong>Erreurs DNS :</strong> {{ dns.error_transactions }} r√©solutions ont √©chou√©.
                                {% if dns.top_problematic_domains %}
                                <br>Domaines introuvables (NXDOMAIN) fr√©quents : <code>{{ dns.top_problematic_domains[0].domain }}</code>. 
                                Cela peut √™tre d√ª √† des blocages (Private Relay, AdBlock) ou des domaines inexistants.
                                {% endif %}
                            </li>
                            {% endif %}

                            {% if patterns and patterns.periodic_patterns %}
                            <li><strong>Trafic p√©riodique :</strong> D√©tection de patterns r√©guliers (probablement des syst√®mes de monitoring ou heartbeat) toutes les {{ patterns.periodic_patterns[0].interval_seconds }} secondes.</li>
                            {% endif %}
                        </ul>

                        <h4>üéØ Impact m√©tier estim√© :</h4>
                        <ul>
                            {% if analysis_info.is_very_small_capture %}
                            <li><strong>Volume de capture :</strong> Capture de faible volume ({{ analysis_info.total_packets }} paquets sur {{ "%.0f"|format(analysis_info.capture_duration) }}s).
                                Les m√©triques statistiques ne sont pas significatives - capture plus longue recommand√©e pour analyse fiable.</li>
                            <li><strong>Impact utilisateur :</strong> Impossible √† √©valuer avec certitude sur ce faible √©chantillon.</li>
                            {% elif analysis_info.is_small_capture %}
                            <li><strong>Volume de capture :</strong> Capture de volume mod√©r√© ({{ analysis_info.total_packets }} paquets).
                                M√©triques indicatives - capture plus longue conseill√©e pour conclusions d√©finitives.</li>
                            <li><strong>Impact utilisateur :</strong> {% if has_incident %}Probl√®mes d√©tect√©s - √† confirmer avec capture plus longue.{% else %}Pas de probl√®me majeur d√©tect√© sur cet √©chantillon.{% endif %}</li>
                            {% else %}
                            {% if has_incident %}
                            <li><strong>Impact utilisateur :</strong> D√©gradations de performance d√©tect√©es - lenteurs possibles, timeouts applicatifs potentiels.</li>
                            <li><strong>Impact applicatif :</strong> Les √©changes entre {{ top_talkers.top_ips[0].ip if top_talkers and top_talkers.top_ips else "serveurs" }} et {{ top_talkers.top_ips[1].ip if top_talkers and top_talkers.top_ips|length > 1 else "clients" }} montrent des anomalies.</li>
                            {% else %}
                            <li><strong>Impact utilisateur :</strong> Fonctionnement normal du r√©seau selon les seuils d√©finis.</li>
                            {% endif %}
                            {% endif %}
                        </ul>

                        <h4>üîß Recommandations :</h4>
                        <ul>
                            {% if analysis_info.is_very_small_capture %}
                            <li><strong>Capture plus longue :</strong> Augmenter la dur√©e de capture (minimum 5 minutes) ou le volume de trafic pour obtenir des statistiques fiables.</li>
                            <li><strong>P√©riode repr√©sentative :</strong> Capturer pendant une p√©riode d'activit√© normale de l'application pour avoir des donn√©es significatives.</li>
                            {% elif analysis_info.is_small_capture %}
                            <li><strong>Validation recommand√©e :</strong> Effectuer une capture plus longue (10-15 minutes) pour confirmer les tendances observ√©es.</li>
                            {% if has_incident %}
                            <li><strong>Investigation :</strong> Si probl√®mes confirm√©s sur capture longue, v√©rifier la charge des serveurs {{ top_talkers.top_ips[0].ip if top_talkers and top_talkers.top_ips else "principaux" }}.</li>
                            {% endif %}
                            {% elif has_incident %}
                            <li><strong>Investigation prioritaire :</strong> V√©rifier la charge CPU/m√©moire des serveurs {{ top_talkers.top_ips[0].ip if top_talkers and top_talkers.top_ips else "principaux" }}.</li>
                            <li><strong>Monitoring r√©seau :</strong> Contr√¥ler l'utilisation de la bande passante sur les √©quipements interm√©diaires.</li>
                            <li><strong>Logs applicatifs :</strong> Corr√©ler avec les logs pendant cette p√©riode pour identifier les timeouts.</li>
                            {% if retransmission and retransmission.rto_count > 0 %}
                            <li><strong>Action imm√©diate :</strong> La pr√©sence de RTOs indique un probl√®me critique de congestion ou de perte de connectivit√©, n√©cessitant une investigation r√©seau urgente.</li>
                            {% elif retransmission and retransmission.total_retransmissions > 5000 %}
                            <li><strong>Action imm√©diate :</strong> Les pertes de paquets sont tr√®s √©lev√©es - investigation r√©seau urgente recommand√©e.</li>
                            {% endif %}
                            {% else %}
                            <li><strong>Surveillance continue :</strong> Le r√©seau fonctionne normalement - maintenir le monitoring en place.</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Rapport g√©n√©r√© par <strong>PCAP Analyzer</strong> - {{ analysis_info.analysis_date }}</p>
        </div>
    </div>

    <script>
        // Toggle collapsible sections
        document.addEventListener('DOMContentLoaded', function() {
            const headers = document.querySelectorAll('.collapsible-header');
            
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    
                    if (content && content.classList.contains('collapsible-content')) {
                        content.classList.toggle('active');
                    }
                });
            });
        });
    </script>
</body>
</html>