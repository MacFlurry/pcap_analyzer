name: Tests

on:
  push:
    branches: [ main, comprehensive-code-review ]
  pull_request:
    branches: [ main ]

jobs:
  version-guards:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[test]
        pip install pytest-asyncio

    - name: Run metadata and test-convention guards
      run: |
        pytest tests/unit/test_version_metadata.py tests/unit/test_test_conventions.py -q

  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]  # macOS disabled: runners often unavailable, causing 24h delays
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcap-dev tcpdump

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install libpcap

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[test]
        pip install pytest-asyncio

    - name: Run tests with pytest
      run: |
        pytest tests/ -v --tb=short --maxfail=5 -m "not property and not integration"

    - name: Run tests with coverage
      if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
      run: |
        pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit

    - name: Run pre-commit hooks
      run: |
        pre-commit run --all-files --show-diff-on-failure

  docker-build:
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking: infrastructure test (Conductor Decision: CI Strategy)
    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t pcap-analyzer:test .

    - name: Test Docker image
      run: |
        docker run -d --name test-container -p 8000:8000 pcap-analyzer:test
        sleep 10
        # Test health endpoint from host
        curl -f http://localhost:8000/api/health || exit 1
        docker stop test-container
        docker rm test-container

  helm-test:
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking: infrastructure test (Conductor Decision: CI Strategy)
    steps:
    - uses: actions/checkout@v3

    - name: Install kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/kubectl

    - name: Install Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

    - name: Create kind cluster
      run: |
        cat <<EOF | kind create cluster --name test-cluster --config -
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
          extraPortMappings:
          - containerPort: 30080
            hostPort: 8000
            protocol: TCP
        EOF

    - name: Build and load Docker image
      run: |
        docker build -t pcap-analyzer:test .
        kind load docker-image pcap-analyzer:test --name test-cluster

    - name: Lint Helm chart
      run: |
        helm lint ./helm-chart/pcap-analyzer

    - name: Install Helm chart
      run: |
        helm install pcap-analyzer ./helm-chart/pcap-analyzer \
          --set image.tag=test \
          --namespace pcap-analyzer \
          --create-namespace \
          --wait \
          --timeout 5m

    - name: Verify deployment
      run: |
        kubectl get all -n pcap-analyzer
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=pcap-analyzer -n pcap-analyzer --timeout=300s

    - name: Test application
      run: |
        # Test using Python (available in container) instead of curl (not installed)
        kubectl exec -n pcap-analyzer deployment/pcap-analyzer -- python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health').read()"

    - name: Show logs on failure
      if: failure()
      run: |
        kubectl logs -n pcap-analyzer deployment/pcap-analyzer --tail=100

    - name: Cleanup
      if: always()
      run: |
        kind delete cluster --name test-cluster
